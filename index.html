import sqlite3
import os
import time
import glob
from config import DATABASE_NAME

def reset_database():
    """
    –†–∞–¥–∏–∫–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –±–∞–∑—ã, –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
    –í–ù–ò–ú–ê–ù–ò–ï: –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã python (bot.py, api_server.py) –û–°–¢–ê–ù–û–í–õ–ï–ù–´.
    """
    print("=" * 60)
    print("üö® –í–ù–ò–ú–ê–ù–ò–ï: –ó–ê–ü–£–©–ï–ù –ü–†–û–¶–ï–°–° –ü–û–õ–ù–û–ô –°–¢–ï–†–ò–õ–ò–ó–ê–¶–ò–ò –°–ò–°–¢–ï–ú–´ üö®")
    print("=" * 60)
    
    # 1. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ SQLite, –≤–∫–ª—é—á–∞—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∂—É—Ä–Ω–∞–ª–æ–≤
    patterns = [
        DATABASE_NAME,
        f"{DATABASE_NAME}-journal",
        f"{DATABASE_NAME}-wal",
        f"{DATABASE_NAME}-shm",
        "*.db",
        "*.db-*"
    ]
    
    found_files = []
    for pattern in patterns:
        found_files.extend(glob.glob(pattern))
    
    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    found_files = list(set(found_files))
    
    if found_files:
        print(f"üïµÔ∏è –ù–∞–π–¥–µ–Ω–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {len(found_files)}")
        for file in found_files:
            try:
                if os.path.exists(file):
                    os.remove(file)
                    print(f"‚úÖ –§–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–Ω–∏—á—Ç–æ–∂–µ–Ω: {file}")
            except PermissionError:
                print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –§–∞–π–ª {file} –ó–ê–ù–Ø–¢!")
                print("üëâ –°–†–û–ß–ù–û: –ó–∞–∫—Ä–æ–π—Ç–µ CMD/–¢–µ—Ä–º–∏–Ω–∞–ª, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä!")
                return
            except Exception as e:
                print(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ {file}: {e}")
    else:
        print("‚ÑπÔ∏è –§–∞–π–ª—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å –Ω—É–ª—è.")

    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
    time.sleep(1)

    # 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–®—Ç–∞–± –í–æ–µ–Ω–Ω–æ–π –ò–µ—Ä–∞—Ä—Ö–∏–∏)
    try:
        conn = sqlite3.connect(DATABASE_NAME)
        c = conn.cursor()

        print("\nüõ† –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü...")

        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –∏–µ—Ä–∞—Ä—Ö–∏—è, –æ–ø—ã—Ç, –∞–¥–º–∏–Ω-–ø—Ä–∞–≤–∞
        c.execute('''
            CREATE TABLE users (
                user_id INTEGER PRIMARY KEY,        -- Telegram ID (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á)
                username TEXT,                      -- @username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                name TEXT,                          -- –§–ò–û (–ø–æ–∑—ã–≤–Ω–æ–π)
                phone TEXT UNIQUE,                  -- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                email TEXT UNIQUE,                  -- –ü–æ—á—Ç–∞
                region TEXT,                        -- –ö–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞
                pin TEXT,                           -- PIN-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞
                role TEXT DEFAULT '–†—è–¥–æ–≤–æ–π',        -- –ó–≤–∞–Ω–∏–µ (–†—è–¥–æ–≤–æ–π, –°–µ—Ä–∂–∞–Ω—Ç –∏ —Ç.–¥.)
                is_admin INTEGER DEFAULT 0,         -- –§–ª–∞–≥ –¥–æ—Å—Ç—É–ø–∞ –∫ —à—Ç–∞–±—É (0 –∏–ª–∏ 1)
                is_blocked INTEGER DEFAULT 0,       -- –°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                registration_date TEXT,             -- –î–∞—Ç–∞ –ø—Ä–∏–∑—ã–≤–∞
                xp INTEGER DEFAULT 0,               -- –û–ø—ã—Ç –∑–∞ –≤–∏–∑–∏—Ç—ã
                points INTEGER DEFAULT 0,           -- –ò–≥—Ä–æ–≤—ã–µ –±–∞–ª–ª—ã
                plan_visits INTEGER DEFAULT 10      -- –ë–æ–µ–≤–∞—è –∑–∞–¥–∞—á–∞ (–ø–ª–∞–Ω –Ω–∞ –ø–µ—Ä–∏–æ–¥)
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –≤–∏–∑–∏—Ç–æ–≤ (–û—Ç—á–µ—Ç—ã –æ –≤—ã–ª–∞–∑–∫–∞—Ö)
        c.execute('''
            CREATE TABLE visits (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                employee_id INTEGER,
                doctor_name TEXT,
                organization TEXT,
                visit_date TEXT,
                points_earned INTEGER DEFAULT 10,
                FOREIGN KEY (employee_id) REFERENCES users (user_id)
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ PIN-–∫–æ–¥–∞
        c.execute('''
            CREATE TABLE IF NOT EXISTS pin_blocks (
                user_id INTEGER PRIMARY KEY,
                failed_attempts INTEGER DEFAULT 0,
                block_until TEXT
            )
        ''')

        conn.commit()
        conn.close()
        
        print("=" * 60)
        print("üöÄ –°–ò–°–¢–ï–ú–ê –£–°–ü–ï–®–ù–û –û–ë–ù–£–õ–ï–ù–ê –ò –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ï–ù–ê")
        print("=" * 60)
        print("üõë –í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´:")
        print("1. –í –¢–ï–õ–ï–§–û–ù–ï: –û—Ç–∫—Ä–æ–π—Ç–µ Mini App -> (‚ãÆ) -> Reload Page (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)")
        print("   –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
        print("2. –ó–ê–ü–£–°–ö: –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ bot.py, –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.")
        print("3. –ü–†–ê–í–ê: –ü–æ—Å–∫–æ–ª—å–∫—É –≤–∞—à ID –≤ config.py, –≤—ã —Å—Ç–∞–Ω–µ—Ç–µ –ì–õ–ê–í–ù–´–ú –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
        print("=" * 60)

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î: {e}")

if __name__ == "__main__":
    reset_database()
