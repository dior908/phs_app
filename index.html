<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞–º–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        console.log('üîß Telegram WebApp API –∑–∞–≥—Ä—É–∂–µ–Ω');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: pan-y;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            width: 100%;
            max-width: 400px;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: linear-gradient(145deg, #e6e9ed 0%, #c5ccd4 100%);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.2), -8px -8px 16px rgba(255, 255, 255, 0.5);
            animation: slideUp 0.5s ease;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .card::-webkit-scrollbar {
            width: 6px;
        }

        .card::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .card::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            margin-bottom: 10px;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.2), -4px -4px 8px rgba(255, 255, 255, 0.5);
        }

        h1 {
            color: #2c3748;
            font-size: 24px;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #546e7a;
            font-size: 13px;
            margin-bottom: 25px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            color: #37474f;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
            background: #d1d9e0;
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.5);
            color: #2c3e50;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            background: #dfe6ed;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.15), inset -2px -2px 5px rgba(255, 255, 255, 0.7);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.2), -4px -4px 8px rgba(255, 255, 255, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #b0bec5, #90a4ae);
        }

        .btn-success {
            background: linear-gradient(145deg, #66bb6a, #4caf50);
        }

        .error {
            color: #d32f2f;
            font-size: 13px;
            margin-top: 8px;
            display: none;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #d32f2f;
        }

        .error.show {
            display: block;
        }

        .hidden {
            display: none;
        }

        .pin-input-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        .pin-digit {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .menu-button {
            padding: 20px;
            background: linear-gradient(145deg, #e6e9ed, #cfd8dc);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.15), -4px -4px 8px rgba(255, 255, 255, 0.5);
        }

        .menu-button:active {
            transform: translateY(0);
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.5);
        }

        .menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .menu-text {
            font-size: 13px;
            font-weight: 600;
            color: #37474f;
        }

        .lang-flags {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .flag-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2), -3px -3px 6px rgba(255, 255, 255, 0.3);
            background: linear-gradient(145deg, #e6e9ed, #cfd8dc);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flag-btn.active {
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .admin-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #ffa726, #ff9800);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2), -3px -3px 6px rgba(255, 255, 255, 0.3);
            z-index: 1000;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #78909c;
            margin-top: 4px;
        }

        .required {
            color: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid #7f8c8d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .location-btn {
            background: linear-gradient(145deg, #42a5f5, #1e88e5);
        }
    </style>
</head>
<body>
    <!-- –§–ª–∞–≥–∏ —è–∑—ã–∫–æ–≤ -->
    <div class="lang-flags" id="langFlags" style="display: none;">
        <button class="flag-btn" id="flagRu" onclick="switchLanguage('ru')" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</button>
        <button class="flag-btn" id="flagUz" onclick="switchLanguage('uz')" title="O'zbekcha">üá∫üáø</button>
    </div>

    <!-- –ê–¥–º–∏–Ω –∏–∫–æ–Ω–∫–∞ -->
    <div class="admin-icon" id="adminIcon" onclick="openAdminPanel()" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" style="display: none;">‚öôÔ∏è</div>

    <div class="container">
        <div class="card">
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
            <div id="loadingScreen" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #546e7a;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <!-- –í—Ö–æ–¥ –ø–æ PIN -->
            <div id="pinLoginScreen" class="hidden">
                <div class="logo">
                    <div class="logo-icon">üîê</div>
                </div>
                <h1 id="loginTitle">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
                <p class="subtitle" id="loginSubtitle">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à PIN-–∫–æ–¥</p>
                <div class="pin-input-container">
                    <input type="password" maxlength="1" class="pin-digit" id="loginPin1" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="loginPin2" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="loginPin3" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="loginPin4" inputmode="numeric">
                </div>
                <div class="error" id="loginPinError">–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥</div>
                <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
            </div>

            <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
            <div id="registrationForm" class="hidden">
                <div class="logo"><div class="logo-icon">üìã</div></div>
                <h1 id="regTitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
                <p class="subtitle" id="regSubtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>
                <form id="regForm">
                    <div class="form-group">
                        <label for="name" id="nameLabel">–ü–æ–ª–Ω–æ–µ –∏–º—è <span class="required">*</span></label>
                        <input type="text" id="name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required>
                        <div class="error" id="nameError">–í–≤–µ–¥–∏—Ç–µ –∏–º—è</div>
                    </div>
                    <div class="form-group">
                        <label for="phone" id="phoneLabel">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ <span class="required">*</span></label>
                        <input type="tel" id="phone" placeholder="+998 90 123 45 67" required>
                        <div class="error" id="phoneError">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä</div>
                    </div>
                    <div class="form-group">
                        <label for="email" id="emailLabel">Email <span class="required">*</span></label>
                        <input type="email" id="email" placeholder="example@mail.com" required>
                        <div class="error" id="emailError">–í–≤–µ–¥–∏—Ç–µ email</div>
                    </div>
                    <div class="form-group">
                        <label for="region" id="regionLabel">–û–±–ª–∞—Å—Ç—å <span class="required">*</span></label>
                        <select id="region" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="tashkent_city">–≥. –¢–∞—à–∫–µ–Ω—Ç</option>
                            <option value="andijan">–ê–Ω–¥–∏–∂–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="bukhara">–ë—É—Ö–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="jizzakh">–î–∂–∏–∑–∞–∫—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="kashkadarya">–ö–∞—à–∫–∞–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="navoi">–ù–∞–≤–æ–∏–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="namangan">–ù–∞–º–∞–Ω–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="samarkand">–°–∞–º–∞—Ä–∫–∞–Ω–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="surkhandarya">–°—É—Ä—Ö–∞–Ω–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="sirdarya">–°—ã—Ä–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="tashkent">–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="fergana">–§–µ—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="khorezm">–•–æ—Ä–µ–∑–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                            <option value="karakalpakstan">–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–∞–∫–∞–ª–ø–∞–∫—Å—Ç–∞–Ω</option>
                        </select>
                        <div class="error" id="regionError">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å</div>
                    </div>
                    <button type="submit" class="btn" id="regSubmitBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                </form>
            </div>

            <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PIN -->
            <div id="pinSetupScreen" class="hidden">
                <div class="logo"><div class="logo-icon">üîê</div></div>
                <h1 id="pinSetupTitle">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PIN-–∫–æ–¥</h1>
                <p class="subtitle" id="pinSetupSubtitle">–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN</p>
                <div class="pin-input-container">
                    <input type="password" maxlength="1" class="pin-digit" id="pin1" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="pin2" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="pin3" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="pin4" inputmode="numeric">
                </div>
                <div class="error" id="pinError">PIN –∏–∑ 4 —Ü–∏—Ñ—Ä</div>
                <button class="btn" id="setPinBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PIN</button>
            </div>

            <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ PIN -->
            <div id="pinConfirmScreen" class="hidden">
                <div class="logo"><div class="logo-icon">‚úÖ</div></div>
                <h1 id="pinConfirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ PIN-–∫–æ–¥</h1>
                <p class="subtitle" id="pinConfirmSubtitle">–í–≤–µ–¥–∏—Ç–µ PIN –µ—â—ë —Ä–∞–∑</p>
                <div class="pin-input-container">
                    <input type="password" maxlength="1" class="pin-digit" id="confirmPin1" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="confirmPin2" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="confirmPin3" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="confirmPin4" inputmode="numeric">
                </div>
                <div class="error" id="confirmPinError">PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç</div>
                <button class="btn" id="confirmPinBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>

            <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
            <div id="languageScreen" class="hidden">
                <div class="logo"><div class="logo-icon">üåê</div></div>
                <h1>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Tilni tanlang</h1>
                <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" style="flex:1;" onclick="setLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
                    <button class="btn" style="flex:1;" onclick="setLanguage('uz')">üá∫üáø O'zbekcha</button>
                </div>
            </div>

            <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
            <div id="mainMenu" class="hidden">
                <div class="logo"><div class="logo-icon">üè†</div></div>
                <h1 id="menuTitle">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
                <p class="subtitle" id="menuSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</p>
                <div class="menu-grid">
                    <div class="menu-button" onclick="openVisitMenu()">
                        <div class="menu-icon">üìù</div>
                        <div class="menu-text" id="menuVisit">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–∏–∑–∏—Ç–∞</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üó∫Ô∏è</div>
                        <div class="menu-text" id="menuMap">–ö–∞—Ä—Ç–∞ –≤–∏–∑–∏—Ç–æ–≤</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üìä</div>
                        <div class="menu-text" id="menuReports">–û—Ç—á–µ—Ç—ã</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üóìÔ∏è</div>
                        <div class="menu-text" id="menuTour">–¢—É—Ä –ø–ª–∞–Ω</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üìö</div>
                        <div class="menu-text" id="menuMaterials">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
                    </div>
                    <div class="menu-button" onclick="openSection('help')">
                        <div class="menu-icon">‚ùì</div>
                        <div class="menu-text" id="menuHelp">–ü–æ–º–æ—â—å</div>
                    </div>
                </div>
            </div>

            <!-- –ú–µ–Ω—é —Ç–∏–ø–æ–≤ –≤–∏–∑–∏—Ç–æ–≤ -->
            <div id="visitTypeMenu" class="hidden">
                <div class="logo"><div class="logo-icon">üìù</div></div>
                <h1 id="visitTypeTitle">–¢–∏–ø –≤–∏–∑–∏—Ç–∞</h1>
                <p class="subtitle" id="visitTypeSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</p>
                <div class="menu-grid">
                    <div class="menu-button" onclick="openVisitForm('doctor')">
                        <div class="menu-icon">üë®‚Äç‚öïÔ∏è</div>
                        <div class="menu-text" id="visitDoctor">–í—Ä–∞—á</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üíä</div>
                        <div class="menu-text" id="visitPharmacy">–ê–ø—Ç–µ–∫–∞</div>
                    </div>
                    <div class="menu-button" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <div class="menu-icon">üì¶</div>
                        <div class="menu-text" id="visitWholesale">–û–ø—Ç–æ–º</div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="backToMainMenu()" style="margin-top:15px;" id="backBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É -->
            <div id="doctorVisitForm" class="hidden">
                <div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
                <h1 id="doctorFormTitle">–í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É</h1>
                <p class="subtitle" id="doctorFormSubtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>
                <form id="doctorForm">
                    <div class="form-group">
                        <label for="doctorName" id="doctorNameLabel">–§–ò–û –í—Ä–∞—á–∞ <span class="required">*</span></label>
                        <input type="text" id="doctorName" required>
                        <div class="error" id="doctorNameError">–í–≤–µ–¥–∏—Ç–µ –§–ò–û</div>
                    </div>
                    <div class="form-group">
                        <label for="doctorPhone" id="doctorPhoneLabel">–¢–µ–ª–µ—Ñ–æ–Ω –≤—Ä–∞—á–∞</label>
                        <input type="tel" id="doctorPhone">
                    </div>
                    <div class="form-group">
                        <label for="organization" id="organizationLabel">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è <span class="required">*</span></label>
                        <input type="text" id="organization" required>
                        <div class="error" id="organizationError">–í–≤–µ–¥–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</div>
                    </div>
                    <div class="form-group">
                        <label for="specialty" id="specialtyLabel">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å <span class="required">*</span></label>
                        <input type="text" id="specialty" required>
                        <div class="error" id="specialtyError">–í–≤–µ–¥–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="form-group">
                        <label for="visitTopic" id="visitTopicLabel">–¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
                        <input type="text" id="visitTopic" required>
                        <div class="error" id="visitTopicError">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É</div>
                    </div>
                    <div class="form-group">
                        <label for="visitResult" id="visitResultLabel">–†–µ–∑—É–ª—å—Ç–∞—Ç <span class="required">*</span></label>
                        <textarea id="visitResult" required minlength="20"></textarea>
                        <div class="char-counter"><span id="resultCounter">0</span>/20 –º–∏–Ω–∏–º—É–º</div>
                        <div class="error" id="visitResultError">–ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    <button type="button" class="btn location-btn" onclick="getLocation()" id="locationBtn">üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</button>
                    <div id="locationStatus" style="text-align:center;margin-top:10px;color:#546e7a;font-size:13px;"></div>
                    <button type="submit" class="btn btn-success" id="submitVisitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="backToVisitMenu()" id="backToVisitBtn">–ù–∞–∑–∞–¥</button>
                </form>
            </div>

            <!-- –ü–æ–º–æ—â—å -->
            <div id="helpScreen" class="hidden">
                <div class="logo"><div class="logo-icon">‚ùì</div></div>
                <h1 id="helpTitle">–ü–æ–º–æ—â—å</h1>
                <p class="subtitle" id="helpSubtitle">–§—É–Ω–∫—Ü–∏–∏</p>
                <div class="menu-grid" style="grid-template-columns:1fr;">
                    <div class="menu-button" onclick="openEditProfile()">
                        <div class="menu-icon">‚úèÔ∏è</div>
                        <div class="menu-text" id="helpEditData">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                    </div>
                    <div class="menu-button" onclick="alert(currentLanguage==='ru'?'–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è':'Yo\\'riqnoma')">
                        <div class="menu-icon">üìñ</div>
                        <div class="menu-text" id="helpInstructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="backToMainMenu()" style="margin-top:20px;" id="helpBackBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
            </div>

            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
            <div id="editProfileScreen" class="hidden">
                <div class="logo"><div class="logo-icon">‚úèÔ∏è</div></div>
                <h1 id="editProfileTitle">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</h1>
                <p class="subtitle" id="editProfileSubtitle">–û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</p>
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editName" id="editNameLabel">–ò–º—è <span class="required">*</span></label>
                        <input type="text" id="editName" required>
                        <div class="error" id="editNameError">–í–≤–µ–¥–∏—Ç–µ –∏–º—è</div>
                    </div>
                    <div class="form-group">
                        <label for="editPhone" id="editPhoneLabel">–¢–µ–ª–µ—Ñ–æ–Ω <span class="required">*</span></label>
                        <input type="tel" id="editPhone" required>
                        <div class="error" id="editPhoneError">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä</div>
                    </div>
                    <div class="form-group">
                        <label for="editEmail" id="editEmailLabel">Email <span class="required">*</span></label>
                        <input type="email" id="editEmail" required>
                        <div class="error" id="editEmailError">–í–≤–µ–¥–∏—Ç–µ email</div>
                    </div>
                    <div class="form-group">
                        <label for="editRegion" id="editRegionLabel">–û–±–ª–∞—Å—Ç—å <span class="required">*</span></label>
                        <select id="editRegion" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                            <option value="tashkent_city">–≥. –¢–∞—à–∫–µ–Ω—Ç</option>
                            <option value="andijan">–ê–Ω–¥–∏–∂–∞–Ω—Å–∫–∞—è</option>
                            <option value="bukhara">–ë—É—Ö–∞—Ä—Å–∫–∞—è</option>
                            <option value="jizzakh">–î–∂–∏–∑–∞–∫—Å–∫–∞—è</option>
                            <option value="kashkadarya">–ö–∞—à–∫–∞–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è</option>
                            <option value="navoi">–ù–∞–≤–æ–∏–π—Å–∫–∞—è</option>
                            <option value="namangan">–ù–∞–º–∞–Ω–≥–∞–Ω—Å–∫–∞—è</option>
                            <option value="samarkand">–°–∞–º–∞—Ä–∫–∞–Ω–¥—Å–∫–∞—è</option>
                            <option value="surkhandarya">–°—É—Ä—Ö–∞–Ω–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è</option>
                            <option value="sirdarya">–°—ã—Ä–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è</option>
                            <option value="tashkent">–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è</option>
                            <option value="fergana">–§–µ—Ä–≥–∞–Ω—Å–∫–∞—è</option>
                            <option value="khorezm">–•–æ—Ä–µ–∑–º—Å–∫–∞—è</option>
                            <option value="karakalpakstan">–ö–∞—Ä–∞–∫–∞–ª–ø–∞–∫—Å—Ç–∞–Ω</option>
                            </select>
                        <div class="error" id="editRegionError">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å</div>
                    </div>
                    <button type="submit" class="btn btn-success" id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditProfile()" id="cancelEditBtn">–û—Ç–º–µ–Ω–∞</button>
                </form>
            </div>

            <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤—Ö–æ–¥ -->
            <div id="adminLoginScreen" class="hidden">
                <div class="logo"><div class="logo-icon">‚öôÔ∏è</div></div>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <p class="subtitle">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</p>
                <div class="pin-input-container">
                    <input type="password" maxlength="1" class="pin-digit" id="adminPin1" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="adminPin2" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="adminPin3" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="adminPin4" inputmode="numeric">
                </div>
                <div class="error" id="adminPinError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
                <button class="btn" onclick="checkAdminPassword()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-secondary" onclick="closeAdminPanel()">–û—Ç–º–µ–Ω–∞</button>
            </div>

            <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
            <div id="adminPanel" class="hidden">
                <div class="logo"><div class="logo-icon">‚öôÔ∏è</div></div>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</p>
                
                <div class="menu-grid" style="margin-top:20px;">
                    <button class="menu-button" onclick="openUsersPanel()">
                        <div class="menu-icon">üë•</div>
                        <div class="menu-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    </button>
                    <button class="menu-button" onclick="openVisitsPanel()">
                        <div class="menu-icon">üìä</div>
                        <div class="menu-text">–í–∏–∑–∏—Ç—ã</div>
                    </button>
                    <button class="menu-button" onclick="openReportsPanel()">
                        <div class="menu-icon">üìà</div>
                        <div class="menu-text">–û—Ç—á–µ—Ç—ã</div>
                    </button>
                    <button class="menu-button" onclick="openSettingsPanel()">
                        <div class="menu-icon">‚öôÔ∏è</div>
                        <div class="menu-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    </button>
                </div>
                
                <button class="btn btn-secondary" onclick="backToMainMenu()" style="margin-top:20px;">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div id="usersPanel" class="hidden">
                <div class="logo"><div class="logo-icon">üë•</div></div>
                <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                <p class="subtitle">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
                
                <div id="usersList" style="background:rgba(255,255,255,0.3);padding:15px;border-radius:12px;margin:20px 0;max-height:450px;overflow-y:auto;">
                    <p style="color:#37474f;font-weight:600;text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                
                <button class="btn btn-secondary" onclick="backToAdminPanel()">–ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button>
            </div>

            <!-- –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div id="userDetailsPanel" class="hidden">
                <div class="logo"><div class="logo-icon">üë§</div></div>
                <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h1>
                <p class="subtitle">–î–µ—Ç–∞–ª–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è</p>
                
                <div id="userDetailsContent" style="background:rgba(255,255,255,0.3);padding:20px;border-radius:12px;margin:20px 0;">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–µ—Ç–∞–ª–∏ -->
                </div>
                
                <div class="menu-grid">
                    <button class="menu-button" onclick="editUserData()" style="background:linear-gradient(145deg, #e3f2fd, #bbdefb);">
                        <div class="menu-icon">‚úèÔ∏è</div>
                        <div class="menu-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                    </button>
                    <button class="menu-button" onclick="changeUserPIN()" style="background:linear-gradient(145deg, #fff3e0, #ffe0b2);">
                        <div class="menu-icon">üîë</div>
                        <div class="menu-text">–°–º–µ–Ω–∏—Ç—å PIN</div>
                    </button>
                    <button class="menu-button" id="blockUserBtn" onclick="toggleBlockUser()" style="background:linear-gradient(145deg, #ffebee, #ffcdd2);">
                        <div class="menu-icon">üö´</div>
                        <div class="menu-text">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
                    </button>
                    <button class="menu-button" onclick="deleteUserConfirm()" style="background:linear-gradient(145deg, #ffcdd2, #ef9a9a);">
                        <div class="menu-icon">üóëÔ∏è</div>
                        <div class="menu-text">–£–¥–∞–ª–∏—Ç—å</div>
                    </button>
                </div>
                
                <button class="btn btn-secondary" onclick="backToUsersList()" style="margin-top:15px;">‚óÄÔ∏è –ö —Å–ø–∏—Å–∫—É</button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Å–º–µ–Ω—ã PIN -->
            <div id="changePinPanel" class="hidden">
                <div class="logo"><div class="logo-icon">üîë</div></div>
                <h1>–°–º–µ–Ω–∞ PIN-–∫–æ–¥–∞</h1>
                <p class="subtitle" id="changePinUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                
                <div class="pin-input-container">
                    <input type="password" maxlength="1" class="pin-digit" id="newPin1" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="newPin2" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="newPin3" inputmode="numeric">
                    <input type="password" maxlength="1" class="pin-digit" id="newPin4" inputmode="numeric">
                </div>
                <div class="error" id="newPinError">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN</div>
                
                <button class="btn btn-success" onclick="confirmPinChange()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π PIN</button>
                <button class="btn btn-secondary" onclick="cancelPinChange()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let userData = {};
        let userPin = '';
        let currentLanguage = 'ru';
        let visitLocation = null;
        let previousScreen = null;

        const translations = {
            ru: {
                loginTitle: '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É',
                loginSubtitle: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à PIN-–∫–æ–¥',
                regTitle: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                regSubtitle: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ',
                nameLabel: '–ü–æ–ª–Ω–æ–µ –∏–º—è',
                phoneLabel: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                emailLabel: 'Email –∞–¥—Ä–µ—Å',
                regionLabel: '–û–±–ª–∞—Å—Ç—å',
                pinSetupTitle: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PIN-–∫–æ–¥',
                pinSetupSubtitle: '–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN',
                pinConfirmTitle: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ PIN-–∫–æ–¥',
                pinConfirmSubtitle: '–í–≤–µ–¥–∏—Ç–µ PIN –µ—â—ë —Ä–∞–∑',
                menuTitle: '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é',
                menuSubtitle: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
                menuVisit: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–∏–∑–∏—Ç–∞',
                menuMap: '–ö–∞—Ä—Ç–∞ –≤–∏–∑–∏—Ç–æ–≤',
                menuReports: '–û—Ç—á–µ—Ç—ã',
                menuTour: '–¢—É—Ä –ø–ª–∞–Ω',
                menuMaterials: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
                menuHelp: '–ü–æ–º–æ—â—å',
                visitTypeTitle: '–¢–∏–ø –≤–∏–∑–∏—Ç–∞',
                visitTypeSubtitle: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∏–∑–∏—Ç–∞',
                visitDoctor: '–í—Ä–∞—á',
                visitPharmacy: '–ê–ø—Ç–µ–∫–∞',
                visitWholesale: '–û–ø—Ç–æ–º',
                backBtn: '–í–µ—Ä–Ω—É—Ç—å—Å—è',
                doctorFormTitle: '–í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É',
                doctorFormSubtitle: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –≤–∏–∑–∏—Ç–µ',
                doctorNameLabel: '–§–ò–û –í—Ä–∞—á–∞',
                doctorPhoneLabel: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤—Ä–∞—á–∞',
                organizationLabel: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
                specialtyLabel: '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å',
                visitTopicLabel: '–¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞',
                visitResultLabel: '–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞',
                locationBtn: 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π',
                submitVisitBtn: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç',
                backToVisitBtn: '–ù–∞–∑–∞–¥',
                helpTitle: '–ü–æ–º–æ—â—å',
                helpSubtitle: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏',
                helpEditData: '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
                helpInstructions: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
                helpBackBtn: '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é',
                editProfileTitle: '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
                editProfileSubtitle: '–û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é',
                editNameLabel: '–ü–æ–ª–Ω–æ–µ –∏–º—è',
                editPhoneLabel: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                editEmailLabel: 'Email –∞–¥—Ä–µ—Å',
                editRegionLabel: '–û–±–ª–∞—Å—Ç—å',
                saveProfileBtn: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è',
                cancelEditBtn: '–û—Ç–º–µ–Ω–∞',
                regSubmitBtn: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'
            },
            uz: {
                loginTitle: 'Tizimga kirish',
                loginSubtitle: 'PIN-kodingizni kiriting',
                regTitle: "Ro'yxatdan o'tish",
                regSubtitle: "Ma'lumotlarni to'ldiring",
                nameLabel: "To'liq ism",
                phoneLabel: 'Telefon raqami',
                emailLabel: 'Email manzil',
                regionLabel: 'Viloyat',
                pinSetupTitle: "PIN-kod o'rnating",
                pinSetupSubtitle: '4 xonali PIN kiriting',
                pinConfirmTitle: 'PIN-kodni tasdiqlang',
                pinConfirmSubtitle: 'PIN-ni yana kiriting',
                menuTitle: 'Asosiy menyu',
                menuSubtitle: 'Harakatni tanlang',
                menuVisit: "Tashrif ro'yxati",
                menuMap: 'Tashriflar xaritasi',
                menuReports: 'Hisobotlar',
                menuTour: 'Tur rejasi',
                menuMaterials: 'Materiallar',
                menuHelp: 'Yordam',
                visitTypeTitle: 'Tashrif turi',
                visitTypeSubtitle: 'Tashrif turini tanlang',
                visitDoctor: 'Shifokor',
                visitPharmacy: 'Dorixona',
                visitWholesale: 'Ulgurji',
                backBtn: 'Ortga',
                doctorFormTitle: 'Shifokor tashrifi',
                doctorFormSubtitle: "Tashrif ma'lumotlarini to'ldiring",
                doctorNameLabel: 'Shifokor F.I.O',
                doctorPhoneLabel: 'Shifokor telefon raqami',
                organizationLabel: 'Tashkilot',
                specialtyLabel: 'Mutaxassislik',
                visitTopicLabel: 'Tashrif mavzusi',
                visitResultLabel: 'Tashrif natijasi',
                locationBtn: "üìç Joylashuvni ulashish",
                submitVisitBtn: 'Tashrifni saqlash',
                backToVisitBtn: 'Ortga',
                helpTitle: 'Yordam',
                helpSubtitle: "Qo'shimcha funksiyalar",
                helpEditData: "Ma'lumotlarni o'zgartirish",
                helpInstructions: "Yo'riqnoma",
                helpBackBtn: 'Menyuga qaytish',
                editProfileTitle: "Ma'lumotlarni o'zgartirish",
                editProfileSubtitle: "Ma'lumotlaringizni yangilang",
                editNameLabel: "To'liq ism",
                editPhoneLabel: 'Telefon raqami',
                editEmailLabel: 'Email manzil',
                editRegionLabel: 'Viloyat',
                saveProfileBtn: "O'zgarishlarni saqlash",
                cancelEditBtn: 'Bekor qilish',
                regSubmitBtn: 'Davom etish'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            updateLanguage();
            
            const userId = tg.initDataUnsafe?.user?.id;
            const savedUser = JSON.parse(localStorage.getItem('user_' + userId) || '{}');
            userData = savedUser;
            userData.language = lang;
            localStorage.setItem('user_' + userId, JSON.stringify(userData));
            
            tg.sendData(JSON.stringify({
                action: 'registration',
                data: userData
            }));
            
            showScreen('mainMenu');
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.getElementById('flagRu').classList.remove('active');
            document.getElementById('flagUz').classList.remove('active');
            document.getElementById('flag' + (lang === 'ru' ? 'Ru' : 'Uz')).classList.add('active');
            updateLanguage();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function updateLanguage() {
            const t = translations[currentLanguage];
            Object.keys(t).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (el.tagName === 'BUTTON' || el.tagName === 'DIV') {
                        el.textContent = t[key];
                    } else {
                        el.innerHTML = t[key];
                    }
                }
            });
        }

        function showScreen(screenId) {
            if (screenId !== 'adminLoginScreen' && screenId !== 'adminPanel') {
                previousScreen = Array.from(document.querySelectorAll('.card > div:not(.hidden)')).find(el => !el.classList.contains('hidden'))?.id;
            }
            
            document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            const langFlags = document.getElementById('langFlags');
            const adminIcon = document.getElementById('adminIcon');
            
            if (screenId === 'mainMenu' || screenId === 'visitTypeMenu' || screenId === 'doctorVisitForm' || 
                screenId === 'helpScreen' || screenId === 'editProfileScreen') {
                langFlags.style.display = 'flex';
                adminIcon.style.display = 'flex';
            } else {
                langFlags.style.display = 'none';
                adminIcon.style.display = 'none';
            }
            
            document.getElementById('flagRu').classList.remove('active');
            document.getElementById('flagUz').classList.remove('active');
            document.getElementById('flag' + (currentLanguage === 'ru' ? 'Ru' : 'Uz')).classList.add('active');
            
            updateLanguage();
            document.querySelector('.card').scrollTop = 0;
        }

        function showError(fieldId, message) {
            const errorEl = document.getElementById(fieldId + 'Error');
            if (message) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            } else {
                errorEl.classList.remove('show');
            }
        }

        function hideAllErrors() {
            document.querySelectorAll('.error').forEach(el => el.classList.remove('show'));
        }

        async function checkRegistration() {
            const userId = tg.initDataUnsafe?.user?.id;
            const savedUser = localStorage.getItem('user_' + userId);
            const savedLang = localStorage.getItem('appLanguage');
            
            if (savedLang) {
                currentLanguage = savedLang;
            }
            
            if (savedUser) {
                showScreen('pinLoginScreen');
                document.getElementById('loginPin1').focus();
            } else {
                showScreen('registrationForm');
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidPhone(phone) {
            return /^[\d\s\+\-\(\)]+$/.test(phone) && phone.replace(/\D/g, '').length >= 9;
        }

        function setupPinNavigation(prefix) {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(prefix + i);
                if (!input) continue;
                
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                    if (e.target.value && i < 4) {
                        document.getElementById(prefix + (i + 1)).focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && i > 1) {
                        document.getElementById(prefix + (i - 1)).focus();
                    }
                });
            }
        }

        setupPinNavigation('loginPin');
        setupPinNavigation('pin');
        setupPinNavigation('confirmPin');
        setupPinNavigation('adminPin');

        document.getElementById('loginBtn').addEventListener('click', () => {
            const pin = ['loginPin1', 'loginPin2', 'loginPin3', 'loginPin4']
                .map(id => document.getElementById(id).value).join('');
            
            const userId = tg.initDataUnsafe?.user?.id;
            const savedData = JSON.parse(localStorage.getItem('user_' + userId) || '{}');
            
            if (pin === savedData.pin) {
                hideAllErrors();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                showScreen('mainMenu');
            } else {
                showError('loginPin', currentLanguage === 'ru' ? '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥' : "Noto'g'ri PIN-kod");
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                ['loginPin1', 'loginPin2', 'loginPin3', 'loginPin4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('loginPin1').focus();
            }
        });

        document.getElementById('regForm').addEventListener('submit', (e) => {
            e.preventDefault();
            hideAllErrors();

            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const region = document.getElementById('region').value;

            let isValid = true;

            if (name.length < 2) {
                showError('name', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                isValid = false;
            }

            if (!isValidPhone(phone)) {
                showError('phone', '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä');
                isValid = false;
            }

            if (!isValidEmail(email)) {
                showError('email', '–í–≤–µ–¥–∏—Ç–µ email');
                isValid = false;
            }

            if (!region) {
                showError('region', '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å');
                isValid = false;
            }

            if (isValid) {
                userData = { name, phone, email, region,
                    telegramId: tg.initDataUnsafe?.user?.id || 'unknown',
                    username: tg.initDataUnsafe?.user?.username || 'unknown'
                };

                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                showScreen('pinSetupScreen');
                document.getElementById('pin1').focus();
            } else {
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        });

        document.getElementById('setPinBtn').addEventListener('click', () => {
            const pin = ['pin1', 'pin2', 'pin3', 'pin4']
                .map(id => document.getElementById(id).value).join('');

            if (pin.length === 4 && /^\d+$/.test(pin)) {
                userPin = pin;
                hideAllErrors();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                showScreen('pinConfirmScreen');
                document.getElementById('confirmPin1').focus();
            } else {
                showError('pin', 'PIN –∏–∑ 4 —Ü–∏—Ñ—Ä');
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        });

        document.getElementById('confirmPinBtn').addEventListener('click', () => {
            const confirmPin = ['confirmPin1', 'confirmPin2', 'confirmPin3', 'confirmPin4']
                .map(id => document.getElementById(id).value).join('');

            if (confirmPin === userPin) {
                userData.pin = userPin;
                hideAllErrors();
                
                const userId = tg.initDataUnsafe?.user?.id;
                localStorage.setItem('user_' + userId, JSON.stringify(userData));

                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

                showScreen('languageScreen');
            } else {
                showError('confirmPin', 'PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç');
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                ['confirmPin1', 'confirmPin2', 'confirmPin3', 'confirmPin4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('confirmPin1').focus();
            }
        });

        function openVisitMenu() {
            showScreen('visitTypeMenu');
        }

        function openVisitForm(type) {
            if (type === 'doctor') {
                showScreen('doctorVisitForm');
            } else {
                alert(currentLanguage === 'ru' ? '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ' : 'Ishlab chiqilmoqda');
            }
        }

        function backToMainMenu() {
            showScreen('mainMenu');
        }

        function backToVisitMenu() {
            showScreen('visitTypeMenu');
        }

        document.getElementById('visitResult')?.addEventListener('input', (e) => {
            document.getElementById('resultCounter').textContent = e.target.value.length;
        });

        function getLocation() {
            const btn = document.getElementById('locationBtn');
            const status = document.getElementById('locationStatus');
            
            btn.disabled = true;
            status.textContent = currentLanguage === 'ru' ? '–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...' : 'Koordinatalar olinmoqda...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        visitLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        status.textContent = currentLanguage === 'ru' ? '‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞' : '‚úÖ Joylashuv olindi';
                        btn.disabled = false;
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    },
                    (error) => {
                        status.textContent = currentLanguage === 'ru' ? '‚ùå –û—à–∏–±–∫–∞' : '‚ùå Xato';
                        btn.disabled = false;
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                    }
                );
            } else {
                status.textContent = currentLanguage === 'ru' ? '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : "‚ùå Qo'llab-quvvatlanmaydi";
                btn.disabled = false;
            }
        }

        document.getElementById('doctorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            hideAllErrors();

            const doctorName = document.getElementById('doctorName').value.trim();
            const doctorPhone = document.getElementById('doctorPhone').value.trim();
            const organization = document.getElementById('organization').value.trim();
            const specialty = document.getElementById('specialty').value.trim();
            const visitTopic = document.getElementById('visitTopic').value.trim();
            const visitResult = document.getElementById('visitResult').value.trim();

            let isValid = true;

            if (!doctorName) {
                showError('doctorName', '–í–≤–µ–¥–∏—Ç–µ –§–ò–û');
                isValid = false;
            }

            if (!organization) {
                showError('organization', '–í–≤–µ–¥–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é');
                isValid = false;
            }

            if (!specialty) {
                showError('specialty', '–í–≤–µ–¥–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å');
                isValid = false;
            }

            if (!visitTopic) {
                showError('visitTopic', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É');
                isValid = false;
            }

            if (visitResult.length < 20) {
                showError('visitResult', '–ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤');
                isValid = false;
            }

            if (isValid) {
                const userId = tg.initDataUnsafe?.user?.id;
                const savedUser = JSON.parse(localStorage.getItem('user_' + userId) || '{}');

                const visitData = {
                    type: 'doctor',
                    doctorName,
                    doctorPhone,
                    organization,
                    specialty,
                    visitTopic,
                    visitResult,
                    location: visitLocation,
                    employee: {
                        id: userId,
                        name: savedUser.name,
                        phone: savedUser.phone,
                        email: savedUser.email
                    },
                    timestamp: new Date().toISOString()
                };

                tg.sendData(JSON.stringify({
                    action: 'visit_registration',
                    data: visitData
                }));

                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                
                alert(currentLanguage === 'ru' ? '–í–∏–∑–∏—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!' : 'Tashrif ro\'yxatga olindi!');
                document.getElementById('doctorForm').reset();
                visitLocation = null;
                document.getElementById('locationStatus').textContent = '';
                document.getElementById('resultCounter').textContent = '0';
                showScreen('mainMenu');
            } else {
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        });

        function openAdminPanel() {
            showScreen('adminLoginScreen');
            document.getElementById('adminPin1').focus();
        }

        function closeAdminPanel() {
            if (previousScreen) {
                showScreen(previousScreen);
            } else {
                showScreen('mainMenu');
            }
        }

        function checkAdminPassword() {
            const pin = ['adminPin1', 'adminPin2', 'adminPin3', 'adminPin4']
                .map(id => document.getElementById(id).value).join('');
            
            if (pin === '0101') {
                hideAllErrors();
                
                const userInfo = tg.initDataUnsafe?.user || {};
                const dataToSend = {
                    action: 'admin_login',
                    user: {
                        id: userInfo.id,
                        first_name: userInfo.first_name,
                        last_name: userInfo.last_name,
                        username: userInfo.username,
                        language_code: userInfo.language_code
                    }
                };
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å');
                tg.sendData(JSON.stringify(dataToSend));
                
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                
                showScreen('adminPanel');
                
                setTimeout(() => {
                    alert(currentLanguage === 'ru' 
                        ? '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!\n\nüìß –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É (–≤–æ–∑–º–æ–∂–Ω–æ –≤ –ø–∞–ø–∫–µ –°–ø–∞–º)' 
                        : '‚úÖ Kirish amalga oshirildi!\n\nüìß Xat administrator emailiga yuborildi.');
                }, 500);
                
            } else {
                // –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN –∫–æ–¥');
                
                const userInfo = tg.initDataUnsafe?.user || {};
                const dataToSend = {
                    action: 'failed_admin_login',
                    user_id: userInfo.id
                };
                
                tg.sendData(JSON.stringify(dataToSend));
                
                showError('adminPin', currentLanguage === 'ru' 
                    ? '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –û—Å—Ç–∞–ª–æ—Å—å 2 –ø–æ–ø—ã—Ç–∫–∏' 
                    : 'Noto\'g\'ri parol! 2 ta urinish qoldi');
                
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                
                ['adminPin1', 'adminPin2', 'adminPin3', 'adminPin4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('adminPin1').focus();
            }
        }

        function openSection(section) {
            if (section === 'help') {
                showScreen('helpScreen');
            } else {
                alert(currentLanguage === 'ru' ? '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ' : 'Ishlab chiqilmoqda');
            }
        }

        // === –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò ===
        
        // API URL - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –°–ï–†–í–ï–†!
        const API_URL = 'http://localhost:5000';  // –õ–æ–∫–∞–ª—å–Ω–æ
        // const API_URL = 'http://–≤–∞—à_ip:5000';  // –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        
        function openUsersPanel() {
            console.log('üìÇ –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            showScreen('usersPanel');
            
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p style="color:#37474f;font-weight:600;text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</p>';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ API
            fetch(`${API_URL}/api/users`)
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', data.count);
                    
                    if (!data.success || data.count === 0) {
                        usersList.innerHTML = `
                            <div style="text-align:center;padding:30px;">
                                <div style="font-size:48px;margin-bottom:15px;">üë•</div>
                                <p style="color:#37474f;font-weight:600;margin-bottom:10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                                <p style="color:#7f8c8d;font-size:13px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '<div style="display:flex;flex-direction:column;gap:12px;">';
                    
                    data.users.forEach((user, index) => {
                        const initial = user.name.charAt(0).toUpperCase();
                        const regionName = getRegionName(user.region) || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                        const phone = user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        const email = user.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        const status = user.is_blocked ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                        const statusColor = user.is_blocked ? '#ef5350' : '#66bb6a';
                        
                        html += `
                            <div onclick="showUserDetailsById(${user.user_id})" style="background:rgba(255,255,255,0.5);padding:15px;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.3s;" 
                                 onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='3px 3px 8px rgba(0,0,0,0.15)'" 
                                 onmouseout="this.style.transform='scale(1)';this.style.boxShadow='2px 2px 6px rgba(0,0,0,0.1)'">
                                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                                    <div style="width:50px;height:50px;background:linear-gradient(145deg, #667eea, #764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:22px;flex-shrink:0;">
                                        ${initial}
                                    </div>
                                    <div style="flex:1;min-width:0;">
                                        <div style="font-weight:600;color:#2c3e50;font-size:16px;margin-bottom:5px;">${user.name}</div>
                                        <div style="font-size:12px;color:${statusColor};font-weight:600;">${status}</div>
                                    </div>
                                </div>
                                <div style="font-size:12px;color:#546e7a;line-height:1.8;border-top:1px solid rgba(0,0,0,0.05);padding-top:10px;">
                                    <div><strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${phone}</div>
                                    <div><strong>üìß Email:</strong> ${email}</div>
                                    <div><strong>üìç –†–µ–≥–∏–æ–Ω:</strong> ${regionName}</div>
                                    <div><strong>üÜî ID:</strong> ${user.user_id}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    usersList.innerHTML = html;
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    usersList.innerHTML = `
                        <div style="text-align:center;padding:30px;">
                            <div style="font-size:48px;margin-bottom:15px;">‚ùå</div>
                            <h3 style="color:#e53935;margin-bottom:10px;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                            <p style="color:#7f8c8d;font-size:14px;margin-bottom:20px;">
                                –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                            </p>
                            <div style="background:rgba(229,57,53,0.1);padding:15px;border-radius:8px;border-left:4px solid #e53935;text-align:left;">
                                <p style="color:#37474f;font-size:13px;line-height:1.6;">
                                    <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
                                    ‚Ä¢ API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω<br>
                                    ‚Ä¢ –ù–µ–≤–µ—Ä–Ω—ã–π URL –≤ –∫–æ–¥–µ<br>
                                    ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å CORS<br><br>
                                    <strong>–†–µ—à–µ–Ω–∏–µ:</strong><br>
                                    –ó–∞–ø—É—Å—Ç–∏—Ç–µ: <code>python api_server.py</code>
                                </p>
                            </div>
                        </div>
                    `;
                });
        }
        
        function showUserDetailsById(userId) {
            console.log('üë§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API
            fetch(`${API_URL}/api/user/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }
                    
                    const user = data.user;
                    currentSelectedUser = { user_id: userId, ...user };
                    
                    const initial = user.name.charAt(0).toUpperCase();
                    const regionName = getRegionName(user.region) || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                    const status = user.is_blocked ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                    const statusColor = user.is_blocked ? '#ef5350' : '#66bb6a';
                    
                    document.getElementById('userDetailsContent').innerHTML = `
                        <div style="text-align:center;margin-bottom:20px;">
                            <div style="width:80px;height:80px;background:linear-gradient(145deg, #667eea, #764ba2);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:36px;margin-bottom:15px;">
                                ${initial}
                            </div>
                            <h2 style="color:#2c3e50;margin:10px 0;">${user.name}</h2>
                            <div style="color:${statusColor};font-weight:600;font-size:16px;">${status}</div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.4);padding:15px;border-radius:8px;">
                            <div style="margin-bottom:10px;font-size:14px;"><strong>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</strong><br>${user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div style="margin-bottom:10px;font-size:14px;"><strong>üìß Email:</strong><br>${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div style="margin-bottom:10px;font-size:14px;"><strong>üìç –†–µ–≥–∏–æ–Ω:</strong><br>${regionName}</div>
                            <div style="margin-bottom:10px;font-size:14px;"><strong>üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong><br>${user.registration_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                            <div style="font-size:14px;"><strong>üÜî ID:</strong><br>${userId}</div>
                        </div>
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                    const blockBtn = document.getElementById('blockUserBtn');
                    if (blockBtn) {
                        if (user.is_blocked) {
                            blockBtn.innerHTML = '<div class="menu-icon">‚úÖ</div><div class="menu-text">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>';
                            blockBtn.style.background = 'linear-gradient(145deg, #e8f5e9, #c8e6c9)';
                        } else {
                            blockBtn.innerHTML = '<div class="menu-icon">üö´</div><div class="menu-text">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>';
                            blockBtn.style.background = 'linear-gradient(145deg, #ffebee, #ffcdd2)';
                        }
                    }
                    
                    showScreen('userDetailsPanel');
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                });
        }

        function openVisitsPanel() {
            alert(currentLanguage === 'ru' ? '–†–∞–∑–¥–µ–ª "–í–∏–∑–∏—Ç—ã" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ' : 'Tashriflar bo\'limi ishlab chiqilmoqda');
        }

        function openReportsPanel() {
            alert(currentLanguage === 'ru' ? '–†–∞–∑–¥–µ–ª "–û—Ç—á–µ—Ç—ã" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ' : 'Hisobotlar bo\'limi ishlab chiqilmoqda');
        }

        function openSettingsPanel() {
            alert(currentLanguage === 'ru' ? '–†–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ' : 'Sozlamalar bo\'limi ishlab chiqilmoqda');
        }

        function backToAdminPanel() {
            showScreen('adminPanel');
        }

        function manageUserById(action) {
            const userId = document.getElementById('manageUserId').value.trim();
            
            if (!userId) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            if (!/^\d+$/.test(userId)) {
                alert('‚ùå ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã');
                return;
            }
            
            console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${action} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
            
            if (action === 'pin') {
                // –°–º–µ–Ω–∞ PIN
                currentSelectedUser = { user_id: userId };
                changeUserPIN();
            } else if (action === 'block') {
                // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) return;
                
                tg.sendData(JSON.stringify({
                    action: 'block_user',
                    user_id: userId,
                    admin_id: tg.initDataUnsafe?.user?.id
                }));
                
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ.');
                
            } else if (action === 'unblock') {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                if (!confirm(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?\n\n–°–Ω–∏–º—É—Ç—Å—è –≤—Å–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–≤–∫–ª—é—á–∞—è PIN).`)) return;
                
                tg.sendData(JSON.stringify({
                    action: 'unblock_user',
                    user_id: userId,
                    admin_id: tg.initDataUnsafe?.user?.id
                }));
                
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ.');
                
            } else if (action === 'delete') {
                // –£–¥–∞–ª–µ–Ω–∏–µ
                if (!confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?\n\n–≠—Ç–æ –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) return;
                
                const confirm2 = prompt('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨"');
                if (confirm2 !== '–£–î–ê–õ–ò–¢–¨') {
                    alert('–û—Ç–º–µ–Ω–µ–Ω–æ');
                    return;
                }
                
                tg.sendData(JSON.stringify({
                    action: 'delete_user',
                    user_id: userId,
                    admin_id: tg.initDataUnsafe?.user?.id
                }));
                
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω!\n\n–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ.');
                document.getElementById('manageUserId').value = '';
            }
        }

        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p style="color:#37474f;font-weight:600;text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>';
            
            console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–æ—Ç—É
            const requestData = {
                action: 'get_users_list',
                admin_id: tg.initDataUnsafe?.user?.id
            };
            
            console.log('üì§ –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', requestData);
            tg.sendData(JSON.stringify(requestData));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ localStorage
            setTimeout(() => {
                const localUsers = [];
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('user_')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            if (userData.name) {
                                localUsers.push(userData);
                            }
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                        }
                    }
                }
                
                console.log('üë• –ù–∞–π–¥–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', localUsers.length);
                
                if (localUsers.length === 0) {
                    usersList.innerHTML = `
                        <div style="text-align:center;padding:30px;">
                            <div style="font-size:48px;margin-bottom:15px;">üë•</div>
                            <p style="color:#37474f;font-weight:600;margin-bottom:10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p style="color:#7f8c8d;font-size:13px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    `;
                } else {
                    let html = '<div style="display:flex;flex-direction:column;gap:12px;">';
                    
                    localUsers.forEach((user, index) => {
                        const initial = user.name.charAt(0).toUpperCase();
                        const regionName = getRegionName(user.region) || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                        const phone = user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        const email = user.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
                        const lang = user.language === 'uz' ? 'O\'zbekcha' : '–†—É—Å—Å–∫–∏–π';
                        const userId = user.user_id || Object.keys(localStorage).find(k => k.startsWith('user_') && JSON.parse(localStorage.getItem(k)).name === user.name)?.replace('user_', '');
                        
                        html += `
                            <div onclick="showUserDetails('${userId}')" style="background:rgba(255,255,255,0.5);padding:15px;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.3s;" 
                                 onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='3px 3px 8px rgba(0,0,0,0.15)'" 
                                 onmouseout="this.style.transform='scale(1)';this.style.boxShadow='2px 2px 6px rgba(0,0,0,0.1)'">
                                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                                    <div style="width:45px;height:45px;background:linear-gradient(145deg, #95a5a6, #7f8c8d);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:20px;flex-shrink:0;">
                                        ${initial}
                                    </div>
                                    <div style="flex:1;min-width:0;">
                                        <div style="font-weight:600;color:#2c3e50;font-size:16px;margin-bottom:3px;">${user.name}</div>
                                        <div style="font-size:12px;color:#7f8c8d;">üëÜ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
                                    </div>
                                </div>
                                <div style="font-size:12px;color:#546e7a;line-height:1.6;border-top:1px solid rgba(0,0,0,0.05);padding-top:10px;">
                                    <div style="margin-bottom:4px;">üìû ${phone}</div>
                                    <div style="margin-bottom:4px;">üìß ${email}</div>
                                    <div style="margin-bottom:4px;">üìç ${regionName}</div>
                                    <div>üåê ${lang}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    usersList.innerHTML = html;
                    
                    console.log('‚úÖ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
                }
            }, 500);
        }

        function getRegionName(regionCode) {
            const regions = {
                'tashkent_city': '–≥. –¢–∞—à–∫–µ–Ω—Ç',
                'andijan': '–ê–Ω–¥–∏–∂–∞–Ω—Å–∫–∞—è –æ–±–ª.',
                'bukhara': '–ë—É—Ö–∞—Ä—Å–∫–∞—è –æ–±–ª.',
                'jizzakh': '–î–∂–∏–∑–∞–∫—Å–∫–∞—è –æ–±–ª.',
                'kashkadarya': '–ö–∞—à–∫–∞–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª.',
                'navoi': '–ù–∞–≤–æ–∏–π—Å–∫–∞—è –æ–±–ª.',
                'namangan': '–ù–∞–º–∞–Ω–≥–∞–Ω—Å–∫–∞—è –æ–±–ª.',
                'samarkand': '–°–∞–º–∞—Ä–∫–∞–Ω–¥—Å–∫–∞—è –æ–±–ª.',
                'surkhandarya': '–°—É—Ä—Ö–∞–Ω–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª.',
                'sirdarya': '–°—ã—Ä–¥–∞—Ä—å–∏–Ω—Å–∫–∞—è –æ–±–ª.',
                'tashkent': '–¢–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª.',
                'fergana': '–§–µ—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª.',
                'khorezm': '–•–æ—Ä–µ–∑–º—Å–∫–∞—è –æ–±–ª.',
                'karakalpakstan': '–ö–∞—Ä–∞–∫–∞–ª–ø–∞–∫—Å—Ç–∞–Ω'
            };
            return regions[regionCode] || regionCode;
        }

        function openEditProfile() {
            const userId = tg.initDataUnsafe?.user?.id;
            const savedUser = JSON.parse(localStorage.getItem('user_' + userId) || '{}');
            
            document.getElementById('editName').value = savedUser.name || '';
            document.getElementById('editPhone').value = savedUser.phone || '';
            document.getElementById('editEmail').value = savedUser.email || '';
            document.getElementById('editRegion').value = savedUser.region || '';
            
            showScreen('editProfileScreen');
        }

        function cancelEditProfile() {
            showScreen('helpScreen');
        }

        document.getElementById('editProfileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            hideAllErrors();

            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const region = document.getElementById('editRegion').value;

            let isValid = true;

            if (name.length < 2) {
                showError('editName', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                isValid = false;
            }

            if (!isValidPhone(phone)) {
                showError('editPhone', '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä');
                isValid = false;
            }

            if (!isValidEmail(email)) {
                showError('editEmail', '–í–≤–µ–¥–∏—Ç–µ email');
                isValid = false;
            }

            if (!region) {
                showError('editRegion', '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å');
                isValid = false;
            }

            if (isValid) {
                const userId = tg.initDataUnsafe?.user?.id;
                const savedUser = JSON.parse(localStorage.getItem('user_' + userId) || '{}');
                
                savedUser.name = name;
                savedUser.phone = phone;
                savedUser.email = email;
                savedUser.region = region;
                
                localStorage.setItem('user_' + userId, JSON.stringify(savedUser));

                tg.sendData(JSON.stringify({
                    action: 'update_profile',
                    data: savedUser
                }));

                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                
                alert(currentLanguage === 'ru' ? '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : 'Ma\'lumotlar yangilandi!');
                showScreen('helpScreen');
            } else {
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        });

        ['name', 'phone', 'email', 'region', 'doctorName', 'organization', 'specialty', 'visitTopic',
         'editName', 'editPhone', 'editEmail', 'editRegion'].forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                el.addEventListener('input', () => showError(field, null));
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò (–ê–î–ú–ò–ù)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentSelectedUser = null;

        function showUserDetails(userId) {
            console.log('üë§ –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            const userData = JSON.parse(localStorage.getItem('user_' + userId) || '{}');
            if (!userData.name) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); return; }
            
            currentSelectedUser = { user_id: userId, ...userData };
            const initial = userData.name.charAt(0).toUpperCase();
            const regionName = getRegionName(userData.region) || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            
            document.getElementById('userDetailsContent').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="width:80px;height:80px;background:linear-gradient(145deg, #95a5a6, #7f8c8d);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:36px;margin-bottom:15px;">${initial}</div>
                    <h2 style="color:#2c3e50;margin:10px 0;">${userData.name}</h2>
                </div>
                <div style="background:rgba(255,255,255,0.4);padding:15px;border-radius:8px;">
                    <div style="margin-bottom:10px;font-size:14px;"><strong>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</strong><br>${userData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div style="margin-bottom:10px;font-size:14px;"><strong>üìß Email:</strong><br>${userData.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    <div style="margin-bottom:10px;font-size:14px;"><strong>üìç –†–µ–≥–∏–æ–Ω:</strong><br>${regionName}</div>
                    <div style="font-size:14px;"><strong>üÜî ID:</strong><br>${userId}</div>
                </div>
            `;
            showScreen('userDetailsPanel');
        }

        function backToUsersList() {
            currentSelectedUser = null;
            showScreen('usersPanel');
        }

        function editUserData() {
            alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        function changeUserPIN() {
            if (!currentSelectedUser) return;
            document.getElementById('changePinUserName').textContent = `ID: ${currentSelectedUser.user_id}`;
            ['newPin1', 'newPin2', 'newPin3', 'newPin4'].forEach(id => document.getElementById(id).value = '');
            hideAllErrors();
            setTimeout(() => document.getElementById('newPin1').focus(), 300);
            
            // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ PIN
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById('newPin' + i);
                input.onkeyup = function() {
                    if (this.value.length === 1 && i < 4) document.getElementById('newPin' + (i + 1)).focus();
                };
            }
            
            showScreen('changePinPanel');
        }

        function confirmPinChange() {
            const newPin = ['newPin1', 'newPin2', 'newPin3', 'newPin4'].map(id => document.getElementById(id).value).join('');
            if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) { showError('newPin', '–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã'); return; }
            
            tg.sendData(JSON.stringify({ action: 'change_user_pin', user_id: currentSelectedUser.user_id, new_pin: newPin, admin_id: tg.initDataUnsafe?.user?.id }));
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            alert('‚úÖ PIN –∏–∑–º–µ–Ω—ë–Ω: ' + newPin);
            showScreen('userDetailsPanel');
        }

        function cancelPinChange() {
            showScreen('userDetailsPanel');
        }

        function toggleBlockUser() {
            if (!currentSelectedUser) return;
            const action = currentSelectedUser.is_blocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            if (!confirm(`${action} ${currentSelectedUser.name}?`)) return;
            
            tg.sendData(JSON.stringify({ action: currentSelectedUser.is_blocked ? 'unblock_user' : 'block_user', user_id: currentSelectedUser.user_id, admin_id: tg.initDataUnsafe?.user?.id }));
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            
            currentSelectedUser.is_blocked = !currentSelectedUser.is_blocked;
            localStorage.setItem('user_' + currentSelectedUser.user_id, JSON.stringify(currentSelectedUser));
            alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentSelectedUser.is_blocked ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}!`);
            backToUsersList();
        }

        function deleteUserConfirm() {
            if (!currentSelectedUser) return;
            if (!confirm(`‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å ${currentSelectedUser.name}?\n\n–≠—Ç–æ –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) return;
            if (prompt('–í–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨"') !== '–£–î–ê–õ–ò–¢–¨') { alert('–û—Ç–º–µ–Ω–µ–Ω–æ'); return; }
            
            tg.sendData(JSON.stringify({ action: 'delete_user', user_id: currentSelectedUser.user_id, admin_id: tg.initDataUnsafe?.user?.id }));
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            localStorage.removeItem('user_' + currentSelectedUser.user_id);
            alert('‚úÖ –£–¥–∞–ª—ë–Ω!');
            currentSelectedUser = null;
            backToUsersList();
            loadUsersList();
        }

        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkRegistration, 500);
        });
    </script>
</body>
</html>
