<!-- –í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É -->
<div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
<h1>–í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É</h1>
<p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞</p>

<form id="visitDoctorForm" onsubmit="submitVisitDoctor(event)">
    <!-- –§–ò–û –í—Ä–∞—á–∞ -->
    <div class="form-group">
        <label for="doctorName">–§–ò–û –í—Ä–∞—á–∞ <span class="required">*</span></label>
        <div style="display:flex;gap:10px;align-items:center;">
            <select id="doctorName" required style="flex:1;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>
                <!-- –°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏–∑ –ë–î -->
            </select>
            <button type="button" class="btn" onclick="loadScreen('add-doctor')" style="padding:12px 20px;min-width:auto;">
                <span style="font-size:20px;">+</span>
            </button>
        </div>
        <div class="error" id="doctorNameError">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</div>
    </div>

    <!-- –¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitTopic">–¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <input type="text" id="visitTopic" placeholder="–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É" required>
        <div class="error" id="visitTopicError">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –≤–∏–∑–∏—Ç–∞</div>
    </div>

    <!-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç -->
    <div class="form-group">
        <label for="productSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç <span class="required">*</span></label>
        <select id="productSelect" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏–∑ –ë–î -->
        </select>
        <div class="error" id="productError">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitResult">–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <textarea id="visitResult" required minlength="20" placeholder="–û–ø–∏—à–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
        <div class="char-counter"><span id="resultCounter">0</span>/20 –º–∏–Ω–∏–º—É–º</div>
        <div class="error" id="visitResultError">–ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <button type="button" class="btn location-btn" onclick="getDoctorLocation()" id="locationBtn">
        üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º
    </button>
    <div id="locationStatus" style="text-align:center;margin-top:10px;color:#546e7a;font-size:13px;"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    <button type="button" class="btn btn-secondary" onclick="backToMainMenu()">‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</form>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–û–†–ú–´ –í–ò–ó–ò–¢–ê –ö –í–†–ê–ß–£
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let visitDoctorLocation = null;
let visitDoctorData = {};

async function init_visit_doctor() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É...');
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
    await loadDoctorsList();
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤
    await loadProductsList();
    
    // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
    const resultTextarea = document.getElementById('visitResult');
    const counter = document.getElementById('resultCounter');
    
    if (resultTextarea && counter) {
        resultTextarea.addEventListener('input', function() {
            counter.textContent = this.value.length;
        });
    }
}

async function loadDoctorsList() {
    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π –∏–∑ –ë–î
     */
    try {
        const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
        
        if (!userId) {
            console.error('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const response = await fetch(`${API_URL}/api/doctors?user_id=${userId}`);
        const data = await response.json();
        
        const select = document.getElementById('doctorName');
        
        if (data.success && data.doctors && data.doctors.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>';
            
            data.doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = `${doctor.full_name} - ${doctor.specialization}`;
                option.dataset.doctor = JSON.stringify(doctor);
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">–ù–µ—Ç –≤—Ä–∞—á–µ–π - –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ä–∞—á–∞ –∫–Ω–æ–ø–∫–æ–π +</option>';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:', error);
        document.getElementById('doctorName').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

async function loadProductsList() {
    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –∏–∑ –ë–î
     */
    try {
        const response = await fetch(`${API_URL}/api/products?active_only=true`);
        const data = await response.json();
        
        const select = document.getElementById('productSelect');
        
        if (data.success && data.products && data.products.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</option>';
            
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">–ù–µ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤</option>';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤:', error);
        document.getElementById('productSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

function getDoctorLocation() {
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    const btn = document.getElementById('locationBtn');
    const status = document.getElementById('locationStatus');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ...';
    status.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                visitDoctorLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                btn.textContent = '‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
                btn.style.background = 'linear-gradient(145deg, #c8e6c9, #a5d6a7)';
                status.textContent = `üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${visitDoctorLocation.latitude.toFixed(6)}, ${visitDoctorLocation.longitude.toFixed(6)}`;
                status.style.color = '#2e7d32';
                
                console.log('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:', visitDoctorLocation);
            },
            (error) => {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                btn.disabled = false;
                btn.textContent = '‚ùå –û—à–∏–±–∫–∞ - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑';
                btn.style.background = 'linear-gradient(145deg, #ffcdd2, #ef9a9a)';
                status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                status.style.color = '#c62828';
            }
        );
    } else {
        btn.disabled = false;
        btn.textContent = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
        status.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é';
        status.style.color = '#c62828';
    }
}

async function submitVisitDoctor(event) {
    /**
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É
     */
    event.preventDefault();
    
    const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
    
    if (!userId) {
        alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
    const doctorSelect = document.getElementById('doctorName');
    const selectedOption = doctorSelect.options[doctorSelect.selectedIndex];
    const doctorData = selectedOption.dataset.doctor ? JSON.parse(selectedOption.dataset.doctor) : null;
    
    const productSelect = document.getElementById('productSelect');
    const selectedProduct = productSelect.options[productSelect.selectedIndex];
    
    const visitData = {
        user_id: userId,
        visit_type: 'doctor',
        employee_contact_id: parseInt(doctorSelect.value),
        contact_type: 'doctor',
        visit_topic: document.getElementById('visitTopic').value,
        products: [selectedProduct.textContent], // –ú–∞—Å—Å–∏–≤ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤
        visit_result: document.getElementById('visitResult').value,
        latitude: visitDoctorLocation?.latitude || null,
        longitude: visitDoctorLocation?.longitude || null,
        address: '' // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å reverse geocoding
    };
    
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–∑–∏—Ç–∞:', visitData);
    
    try {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        const response = await fetch(`${API_URL}/api/visits`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(visitData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            
            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('visitDoctorForm').reset();
            visitDoctorLocation = null;
            document.getElementById('locationStatus').textContent = '';
            document.getElementById('locationBtn').textContent = 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º';
            document.getElementById('locationBtn').style.background = '';
            
            // –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            backToMainMenu();
            
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: ${error.message}`);
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç';
    }
}
</script>
