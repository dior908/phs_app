<!-- –í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É -->
<div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
<h1>–í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É</h1>
<p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞</p>

<form id="visitDoctorForm" onsubmit="submitVisitDoctor(event)">
    <!-- –§–ò–û –í—Ä–∞—á–∞ - –ü–û–ò–°–ö -->
    <div class="form-group">
        <label for="doctorSearch">–§–ò–û –í—Ä–∞—á–∞ <span class="required">*</span></label>
        <input type="text" 
               id="doctorSearch" 
               placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û –≤—Ä–∞—á–∞..." 
               autocomplete="off"
               oninput="searchDoctorsByName()"
               required>
        <div class="error" id="doctorSearchError">–í–≤–µ–¥–∏—Ç–µ –§–ò–û –≤—Ä–∞—á–∞</div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <div id="doctorSearchResults" style="display:none;background:#fff;border:1px solid #ddd;border-radius:8px;margin-top:5px;max-height:200px;overflow-y:auto;"></div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –≤—Ä–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω -->
        <div id="doctorNotFound" style="display:none;background:#fff3cd;padding:10px;border-radius:8px;margin-top:10px;color:#856404;font-size:14px;">
            ‚ö†Ô∏è –í—Ä–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞.
        </div>
        
        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞ -->
        <input type="hidden" id="selectedDoctorId" required>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞ -->
    <button type="button" class="btn" onclick="loadScreen('add-doctor')" style="width:100%;margin-bottom:20px;background:linear-gradient(145deg, #e3f2fd, #bbdefb);">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞
    </button>

    <!-- –¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitTopic">–¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <input type="text" id="visitTopic" placeholder="–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É" required>
        <div class="error" id="visitTopicError">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –≤–∏–∑–∏—Ç–∞</div>
    </div>

    <!-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç -->
    <div class="form-group">
        <label for="productSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç <span class="required">*</span></label>
        <select id="productSelect" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
        <div class="error" id="productError">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitResult">–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <textarea id="visitResult" required minlength="20" placeholder="–û–ø–∏—à–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
        <div class="char-counter"><span id="resultCounter">0</span>/20 –º–∏–Ω–∏–º—É–º</div>
        <div class="error" id="visitResultError">–ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <button type="button" class="btn location-btn" onclick="getDoctorLocationFixed()" id="locationBtn">
        üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º
    </button>
    <div id="locationStatus" style="text-align:center;margin-top:10px;color:#546e7a;font-size:13px;"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    <button type="button" class="btn btn-secondary" onclick="backToMainMenu()">‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</form>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–û–†–ú–´ –í–ò–ó–ò–¢–ê –ö –í–†–ê–ß–£
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let visitDoctorLocation = null;
let allDoctorsCache = [];
let searchTimeout = null;

async function init_visit_doctor() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É...');
    await loadDoctorsForSearch();
    await loadProductsList();
    
    const resultTextarea = document.getElementById('visitResult');
    const counter = document.getElementById('resultCounter');
    
    if (resultTextarea && counter) {
        resultTextarea.addEventListener('input', function() {
            counter.textContent = this.value.length;
        });
    }
}

async function loadDoctorsForSearch() {
    try {
        const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
        
        if (!userId) {
            console.error('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const response = await fetch(`${API_URL}/api/doctors?user_id=${userId}`, {
            headers: {'ngrok-skip-browser-warning': 'true'}
        });
        const data = await response.json();
        
        if (data.success && data.doctors) {
            allDoctorsCache = data.doctors;
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allDoctorsCache.length} –≤—Ä–∞—á–µ–π`);
        } else {
            allDoctorsCache = [];
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:', error);
        allDoctorsCache = [];
    }
}

function searchDoctorsByName() {
    const searchInput = document.getElementById('doctorSearch');
    const searchText = searchInput.value.trim().toLowerCase();
    
    if (searchTimeout) clearTimeout(searchTimeout);
    
    document.getElementById('selectedDoctorId').value = '';
    
    if (searchText.length === 0) {
        document.getElementById('doctorSearchResults').style.display = 'none';
        document.getElementById('doctorNotFound').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => performDoctorSearch(searchText), 300);
}

function performDoctorSearch(searchText) {
    const resultsContainer = document.getElementById('doctorSearchResults');
    const notFoundDiv = document.getElementById('doctorNotFound');
    
    const filteredDoctors = allDoctorsCache.filter(doctor => 
        doctor.full_name.toLowerCase().includes(searchText)
    );
    
    if (filteredDoctors.length === 0) {
        resultsContainer.style.display = 'none';
        notFoundDiv.style.display = 'block';
        return;
    }
    
    notFoundDiv.style.display = 'none';
    
    let html = '';
    filteredDoctors.forEach(doctor => {
        html += `
            <div style="padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s;"
                 onclick="selectDoctor(${doctor.id}, '${doctor.full_name.replace(/'/g, "\\'")}')"
                 onmouseover="this.style.background='#f5f5f5'"
                 onmouseout="this.style.background='#fff'">
                <div style="font-weight:600;color:#1976d2;font-size:15px;">${doctor.full_name}</div>
                <div style="color:#546e7a;font-size:13px;margin-top:3px;">
                    üè• ${doctor.specialization}
                    ${doctor.workplace ? ` ‚Ä¢ ${doctor.workplace}` : ''}
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

function selectDoctor(doctorId, doctorName) {
    document.getElementById('doctorSearch').value = doctorName;
    document.getElementById('selectedDoctorId').value = doctorId;
    document.getElementById('doctorSearchResults').style.display = 'none';
    document.getElementById('doctorNotFound').style.display = 'none';
    console.log(`‚úÖ –í—ã–±—Ä–∞–Ω –≤—Ä–∞—á: ${doctorName} (ID: ${doctorId})`);
}

async function loadProductsList() {
    try {
        const response = await fetch(`${API_URL}/api/products?active_only=true`, {
            headers: {'ngrok-skip-browser-warning': 'true'}
        });
        const data = await response.json();
        
        const select = document.getElementById('productSelect');
        
        if (data.success && data.products && data.products.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</option>';
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">–ù–µ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤</option>';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤:', error);
        document.getElementById('productSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

function getDoctorLocationFixed() {
    const btn = document.getElementById('locationBtn');
    const status = document.getElementById('locationStatus');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ...';
    status.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
    status.style.color = '#546e7a';
    
    if (!navigator.geolocation) {
        btn.disabled = false;
        btn.textContent = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
        status.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é';
        status.style.color = '#c62828';
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        // Success
        (position) => {
            visitDoctorLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };
            
            btn.disabled = false;
            btn.textContent = '‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
            btn.style.background = 'linear-gradient(145deg, #c8e6c9, #a5d6a7)';
            status.textContent = '‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞';
            status.style.color = '#2e7d32';
            
            console.log('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:', visitDoctorLocation);
            
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        },
        // Error
        (error) => {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            
            btn.disabled = false;
            btn.textContent = 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º';
            btn.style.background = '';
            status.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
            status.style.color = '#c62828';
            
            visitDoctorLocation = null;
            
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        },
        // Options
        {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

async function submitVisitDoctor(event) {
    event.preventDefault();
    
    const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
    
    if (!userId) {
        alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    const selectedDoctorId = document.getElementById('selectedDoctorId').value;
    
    if (!selectedDoctorId) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ');
        document.getElementById('doctorSearch').focus();
        return;
    }
    
    const productSelect = document.getElementById('productSelect');
    const selectedProduct = productSelect.options[productSelect.selectedIndex];
    
    const visitData = {
        user_id: userId,
        visit_type: 'doctor',
        employee_contact_id: parseInt(selectedDoctorId),
        contact_type: 'doctor',
        visit_topic: document.getElementById('visitTopic').value,
        products: [selectedProduct.textContent],
        visit_result: document.getElementById('visitResult').value,
        latitude: visitDoctorLocation?.latitude || null,
        longitude: visitDoctorLocation?.longitude || null,
        address: ''
    };
    
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–∑–∏—Ç–∞:', visitData);
    
    try {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        const response = await fetch(`${API_URL}/api/visits`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(visitData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            
            document.getElementById('visitDoctorForm').reset();
            document.getElementById('selectedDoctorId').value = '';
            visitDoctorLocation = null;
            document.getElementById('locationStatus').textContent = '';
            document.getElementById('locationBtn').textContent = 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º';
            document.getElementById('locationBtn').style.background = '';
            document.getElementById('doctorSearchResults').style.display = 'none';
            document.getElementById('doctorNotFound').style.display = 'none';
            
            backToMainMenu();
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: ${error.message}`);
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç';
    }
}
</script>
