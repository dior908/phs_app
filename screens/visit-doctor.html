<!-- –í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É -->
<div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
<h1>–í–∏–∑–∏—Ç –∫ –≤—Ä–∞—á—É</h1>
<p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞</p>

<form id="visitDoctorForm" onsubmit="submitVisitDoctor(event)">
    <!-- –í—ã–±–æ—Ä –≤—Ä–∞—á–∞ - –ö–ù–û–ü–ö–ê -->
    <div class="form-group">
        <label>–í—Ä–∞—á <span class="required">*</span></label>
        
        <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤—Ä–∞—á -->
        <div id="selectedDoctorDisplay" style="display:none;background:rgba(25,118,210,0.1);padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #1976d2;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:600;color:#1976d2;font-size:15px;" id="selectedDoctorName"></div>
                    <div style="color:#546e7a;font-size:13px;margin-top:3px;" id="selectedDoctorInfo"></div>
                </div>
                <button type="button" onclick="clearSelectedDoctor()" style="background:#ef5350;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">
                    ‚úñÔ∏è
                </button>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ -->
        <div id="doctorSelectButtons" style="display:grid;gap:10px;">
            <button type="button" class="btn" onclick="openDoctorSelector()" style="background:linear-gradient(145deg, #e3f2fd, #bbdefb);">
                üîç –í—ã–±—Ä–∞—Ç—å –≤—Ä–∞—á–∞ –∏–∑ –±–∞–∑—ã
            </button>
            <button type="button" class="btn" onclick="loadScreen('add-doctor')" style="background:linear-gradient(145deg, #e8f5e9, #c8e6c9);">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞
            </button>
        </div>
        
        <input type="hidden" id="selectedDoctorId" required>
        <div class="error" id="doctorError">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</div>
    </div>

    <!-- –¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitTopic">–¢–µ–º–∞ –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <input type="text" id="visitTopic" placeholder="–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É" required>
    </div>

    <!-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç -->
    <div class="form-group">
        <label for="productSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç <span class="required">*</span></label>
        <select id="productSelect" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ -->
    <div class="form-group">
        <label for="visitResult">–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ <span class="required">*</span></label>
        <textarea id="visitResult" required minlength="20" placeholder="–û–ø–∏—à–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∑–∏—Ç–∞ (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
        <div class="char-counter"><span id="resultCounter">0</span>/20 –º–∏–Ω–∏–º—É–º</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
    <button type="button" class="btn location-btn" onclick="getDoctorLocationFixed()" id="locationBtn">
        üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º
    </button>
    <div id="locationStatus" style="text-align:center;margin-top:10px;color:#546e7a;font-size:13px;"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç</button>
    <button type="button" class="btn btn-secondary" onclick="backToMainMenu()">‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</form>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –í–†–ê–ß–ê -->
<div id="doctorSelectorModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;padding:20px;overflow-y:auto;">
    <div style="background:white;border-radius:12px;max-width:600px;margin:20px auto;padding:20px;">
        <h2 style="margin:0 0 15px 0;">–í—ã–±–æ—Ä –≤—Ä–∞—á–∞</h2>
        
        <!-- –ü–æ–∏—Å–∫ -->
        <div style="position:relative;margin-bottom:15px;">
            <input type="text" 
                   id="doctorSearchInput" 
                   placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –§–ò–û..." 
                   oninput="filterDoctorsList()"
                   style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;">
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π -->
        <div id="doctorsListContainer" style="max-height:400px;overflow-y:auto;">
            <p style="text-align:center;color:#78909c;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π...</p>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
        <button type="button" class="btn btn-secondary" onclick="closeDoctorSelector()" style="width:100%;margin-top:15px;">
            ‚úñÔ∏è –ó–∞–∫—Ä—ã—Ç—å
        </button>
    </div>
</div>

<script>
let visitDoctorLocation = null;
let allDoctorsCache = [];

async function init_visit_doctor() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É...');
    
    await loadProductsList();
    
    const resultTextarea = document.getElementById('visitResult');
    const counter = document.getElementById('resultCounter');
    
    if (resultTextarea && counter) {
        resultTextarea.addEventListener('input', function() {
            counter.textContent = this.value.length;
        });
    }
}

async function openDoctorSelector() {
    console.log('üìÇ –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–∞—á–∞...');
    
    document.getElementById('doctorSelectorModal').style.display = 'block';
    document.getElementById('doctorSearchInput').value = '';
    
    await loadDoctorsList();
}

function closeDoctorSelector() {
    document.getElementById('doctorSelectorModal').style.display = 'none';
}

async function loadDoctorsList() {
    const container = document.getElementById('doctorsListContainer');
    container.innerHTML = '<p style="text-align:center;color:#78909c;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π...</p>';
    
    try {
        const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
        const API_URL = window.API_URL;
        
        console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π...');
        console.log('   API_URL:', API_URL);
        console.log('   User ID:', userId);
        
        const response = await fetch(`${API_URL}/api/doctors?user_id=${userId}`, {
            headers: {'ngrok-skip-browser-warning': 'true'}
        });
        
        console.log('üì® Response status:', response.status);
        
        const data = await response.json();
        
        console.log('üì¶ –î–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–µ–π:', data);
        
        if (data.success && data.doctors && data.doctors.length > 0) {
            allDoctorsCache = data.doctors;
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allDoctorsCache.length} –≤—Ä–∞—á–µ–π:`);
            allDoctorsCache.forEach(doc => {
                console.log(`   - ${doc.full_name} (ID: ${doc.id})`);
            });
            
            displayDoctorsList(allDoctorsCache);
        } else {
            allDoctorsCache = [];
            container.innerHTML = `
                <div style="text-align:center;padding:40px;color:#78909c;">
                    <div style="font-size:40px;margin-bottom:15px;">üë®‚Äç‚öïÔ∏è</div>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≤—Ä–∞—á–µ–π –≤ –±–∞–∑–µ</p>
                    <button type="button" class="btn" onclick="closeDoctorSelector(); loadScreen('add-doctor');" style="margin-top:15px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –≤—Ä–∞—á–∞
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:', error);
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:#c62828;">
                <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π</p>
                <button class="btn" onclick="loadDoctorsList()" style="margin-top:10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
            </div>
        `;
    }
}

function displayDoctorsList(doctors) {
    const container = document.getElementById('doctorsListContainer');
    
    if (doctors.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#78909c;padding:20px;">–í—Ä–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = '<div style="display:grid;gap:10px;">';
    
    doctors.forEach(doctor => {
        html += `
            <div onclick="selectDoctorFromList(${doctor.id}, '${doctor.full_name.replace(/'/g, "\\'")}', '${doctor.specialization}', '${doctor.workplace || ''}')"
                 style="background:#f5f5f5;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.2s;border-left:4px solid #1976d2;"
                 onmouseover="this.style.background='#e3f2fd'"
                 onmouseout="this.style.background='#f5f5f5'">
                <div style="font-weight:600;color:#1976d2;font-size:15px;">${doctor.full_name}</div>
                <div style="color:#546e7a;font-size:13px;margin-top:5px;">
                    üè• ${doctor.specialization}
                    ${doctor.workplace ? ` ‚Ä¢ ${doctor.workplace}` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function filterDoctorsList() {
    const searchText = document.getElementById('doctorSearchInput').value.toLowerCase().trim();
    
    console.log('üîç –ü–æ–∏—Å–∫:', searchText);
    
    if (searchText === '') {
        displayDoctorsList(allDoctorsCache);
        return;
    }
    
    const filtered = allDoctorsCache.filter(doctor => 
        doctor.full_name.toLowerCase().includes(searchText)
    );
    
    console.log(`   –ù–∞–π–¥–µ–Ω–æ: ${filtered.length} –≤—Ä–∞—á–µ–π`);
    
    displayDoctorsList(filtered);
}

function selectDoctorFromList(id, fullName, specialization, workplace) {
    console.log(`‚úÖ –í—ã–±—Ä–∞–Ω –≤—Ä–∞—á: ${fullName} (ID: ${id})`);
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ID
    document.getElementById('selectedDoctorId').value = id;
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞
    document.getElementById('selectedDoctorName').textContent = fullName;
    document.getElementById('selectedDoctorInfo').textContent = `üè• ${specialization}${workplace ? ' ‚Ä¢ ' + workplace : ''}`;
    
    document.getElementById('selectedDoctorDisplay').style.display = 'block';
    document.getElementById('doctorSelectButtons').style.display = 'none';
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    closeDoctorSelector();
}

function clearSelectedDoctor() {
    document.getElementById('selectedDoctorId').value = '';
    document.getElementById('selectedDoctorDisplay').style.display = 'none';
    document.getElementById('doctorSelectButtons').style.display = 'grid';
}

async function loadProductsList() {
    try {
        const API_URL = window.API_URL;
        
        const response = await fetch(`${API_URL}/api/products?active_only=true`, {
            headers: {'ngrok-skip-browser-warning': 'true'}
        });
        const data = await response.json();
        
        const select = document.getElementById('productSelect');
        
        if (data.success && data.products && data.products.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç</option>';
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">–ù–µ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)</option>';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤:', error);
        document.getElementById('productSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

function getDoctorLocationFixed() {
    const btn = document.getElementById('locationBtn');
    const status = document.getElementById('locationStatus');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ...';
    status.textContent = '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...';
    status.style.color = '#546e7a';
    
    console.log('üåç –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...');
    
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        
        console.log('üì± –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ Telegram WebApp...');
        
        tg.showPopup({
            title: '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è',
            message: '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é',
            buttons: [
                {id: 'ok', type: 'default', text: '–†–∞–∑—Ä–µ—à–∏—Ç—å'},
                {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
            ]
        }, function(buttonId) {
            if (buttonId === 'ok') {
                tryNavigatorGeolocation(btn, status);
            } else {
                btn.disabled = false;
                btn.textContent = 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º';
                status.textContent = '–û—Ç–º–µ–Ω–µ–Ω–æ';
                status.style.color = '#78909c';
            }
        });
    } else {
        console.log('üåê –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ navigator.geolocation...');
        tryNavigatorGeolocation(btn, status);
    }
}

function tryNavigatorGeolocation(btn, status) {
    if (!navigator.geolocation) {
        console.error('‚ùå navigator.geolocation –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        btn.disabled = false;
        btn.textContent = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
        status.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é';
        status.style.color = '#c62828';
        return;
    }
    
    console.log('‚úÖ navigator.geolocation –¥–æ—Å—Ç—É–ø–µ–Ω');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            visitDoctorLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };
            
            btn.disabled = false;
            btn.textContent = '‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
            btn.style.background = 'linear-gradient(145deg, #c8e6c9, #a5d6a7)';
            status.textContent = `‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã`;
            status.style.color = '#2e7d32';
            
            console.log('‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:', visitDoctorLocation);
            
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        },
        (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            console.error('   Code:', error.code);
            
            btn.disabled = false;
            btn.textContent = 'üìç –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑';
            btn.style.background = '';
            
            let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            
            switch(error.code) {
                case 1:
                    errorMsg = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞.';
                    break;
                case 2:
                    errorMsg = 'GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í—ã–π–¥–∏—Ç–µ –Ω–∞ —É–ª–∏—Ü—É –∏–ª–∏ –∫ –æ–∫–Ω—É.';
                    break;
                case 3:
                    errorMsg = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                    break;
            }
            
            status.textContent = `‚ùå ${errorMsg}`;
            status.style.color = '#c62828';
            
            visitDoctorLocation = null;
            
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        },
        {enableHighAccuracy: true, timeout: 20000, maximumAge: 0}
    );
}

async function submitVisitDoctor(event) {
    event.preventDefault();
    
    const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
    
    if (!userId) {
        alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    const selectedDoctorId = document.getElementById('selectedDoctorId').value;
    
    if (!selectedDoctorId) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞');
        return;
    }
    
    const productSelect = document.getElementById('productSelect');
    const selectedProduct = productSelect.options[productSelect.selectedIndex];
    
    const visitData = {
        user_id: userId,
        visit_type: 'doctor',
        employee_contact_id: parseInt(selectedDoctorId),
        contact_type: 'doctor',
        visit_topic: document.getElementById('visitTopic').value,
        products: [selectedProduct.textContent],
        visit_result: document.getElementById('visitResult').value,
        latitude: visitDoctorLocation?.latitude || null,
        longitude: visitDoctorLocation?.longitude || null,
        address: ''
    };
    
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–∑–∏—Ç–∞:', visitData);
    
    try {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        const API_URL = window.API_URL;
        
        const response = await fetch(`${API_URL}/api/visits`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(visitData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            
            document.getElementById('visitDoctorForm').reset();
            clearSelectedDoctor();
            visitDoctorLocation = null;
            document.getElementById('locationStatus').textContent = '';
            document.getElementById('locationBtn').textContent = 'üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º';
            document.getElementById('locationBtn').style.background = '';
            
            backToMainMenu();
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: ${error.message}`);
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç';
    }
}
</script>
