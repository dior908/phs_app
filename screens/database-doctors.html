<!-- –ë–∞–∑–∞ –≤—Ä–∞—á–µ–π -->
<div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
<h1>–ë–∞–∑–∞ –≤—Ä–∞—á–µ–π</h1>
<p class="subtitle">–ü–æ–∏—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>

<!-- –ü–æ–∏—Å–∫ -->
<div class="form-group">
    <input type="text" 
           id="searchDoctors" 
           placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –§–ò–û –≤—Ä–∞—á–∞..."
           onkeyup="searchDoctorsInDatabase()">
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div style="display:flex;gap:10px;margin-bottom:20px;">
    <select id="filterSpecialization" onchange="filterDoctorsInDatabase()" style="flex:1;">
        <option value="">–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</option>
        <option value="–û–Ω–∫–æ–ª–æ–≥–∏—è">–û–Ω–∫–æ–ª–æ–≥–∏—è</option>
        <option value="–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è">–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è</option>
        <option value="–ì–∏–Ω–µ–∫–æ–ª–æ–≥–∏—è">–ì–∏–Ω–µ–∫–æ–ª–æ–≥–∏—è</option>
        <option value="–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è">–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è</option>
        <option value="–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è">–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è</option>
    </select>
    
    <select id="filterCategory" onchange="filterDoctorsInDatabase()" style="flex:1;">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="A">–ö–∞—Ç–µ–≥–æ—Ä–∏—è A</option>
        <option value="B">–ö–∞—Ç–µ–≥–æ—Ä–∏—è B</option>
        <option value="C">–ö–∞—Ç–µ–≥–æ—Ä–∏—è C</option>
    </select>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<button class="btn btn-success" onclick="exportDoctorsToExcel()" style="width:100%;margin-bottom:20px;">
    üìä –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel
</button>

<!-- –°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π -->
<div id="doctorsList" style="background:rgba(255,255,255,0.3);padding:15px;border-radius:12px;max-height:400px;overflow-y:auto;">
    <p style="text-align:center;color:#546e7a;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ -->
<button class="btn" onclick="loadScreen('add-doctor')" style="margin-top:15px;width:100%;">
    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞
</button>
<button class="btn btn-secondary" onclick="backToDatabaseMain()" style="margin-top:10px;">
    ‚óÄÔ∏è –ù–∞–∑–∞–¥
</button>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –í–†–ê–ß–ï–ô
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function backToDatabaseMain() {
    loadScreen('database-main');
}

let allDoctors = [];
let filteredDoctors = [];

async function init_database_doctors() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –≤—Ä–∞—á–µ–π...');
    await loadDoctorsDatabase();
}

async function loadDoctorsDatabase() {
    /**
     * –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö –≤—Ä–∞—á–µ–π –∏–∑ –ë–î
     */
    try {
        const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
        
        if (!userId) {
            console.error('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const response = await fetch(`${API_URL}/api/doctors?user_id=${userId}`);
        const data = await response.json();
        
        if (data.success && data.doctors) {
            allDoctors = data.doctors;
            filteredDoctors = allDoctors;
            renderDoctorsList();
        } else {
            document.getElementById('doctorsList').innerHTML = 
                '<p style="text-align:center;color:#78909c;">–í—Ä–∞—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ!</p>';
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:', error);
        document.getElementById('doctorsList').innerHTML = 
            '<p style="text-align:center;color:#c62828;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
}

function renderDoctorsList() {
    /**
     * –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
     */
    const container = document.getElementById('doctorsList');
    
    if (filteredDoctors.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#78909c;">–í—Ä–∞—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
    }
    
    let html = '';
    
    filteredDoctors.forEach(doctor => {
        const categoryBadge = doctor.category ? 
            `<span style="background:#ffa726;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">
                ${doctor.category}
            </span>` : '';
        
        html += `
            <div style="background:#fff;padding:15px;border-radius:12px;margin-bottom:10px;cursor:pointer;transition:transform 0.2s;"
                 onclick="viewDoctorDetails(${doctor.id})"
                 onmouseover="this.style.transform='scale(1.02)'"
                 onmouseout="this.style.transform='scale(1)'">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <strong style="color:#1976d2;font-size:16px;">${doctor.full_name}</strong>
                    ${categoryBadge}
                </div>
                <div style="color:#546e7a;font-size:14px;margin-bottom:4px;">
                    üè• ${doctor.specialization}
                </div>
                ${doctor.specialty_detail ? `
                <div style="color:#78909c;font-size:13px;margin-bottom:4px;">
                    ${doctor.specialty_detail}
                </div>` : ''}
                ${doctor.workplace ? `
                <div style="color:#78909c;font-size:13px;">
                    üìç ${doctor.workplace}
                </div>` : ''}
                ${doctor.phone ? `
                <div style="color:#78909c;font-size:13px;margin-top:4px;">
                    üìû ${doctor.phone}
                </div>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function searchDoctorsInDatabase() {
    /**
     * –ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π –ø–æ –§–ò–û
     */
    const searchText = document.getElementById('searchDoctors').value.toLowerCase();
    
    filteredDoctors = allDoctors.filter(doctor => 
        doctor.full_name.toLowerCase().includes(searchText)
    );
    
    renderDoctorsList();
}

function filterDoctorsInDatabase() {
    /**
     * –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤—Ä–∞—á–µ–π
     */
    const specialization = document.getElementById('filterSpecialization').value;
    const category = document.getElementById('filterCategory').value;
    
    filteredDoctors = allDoctors.filter(doctor => {
        let match = true;
        
        if (specialization && doctor.specialization !== specialization) {
            match = false;
        }
        
        if (category && doctor.category !== category) {
            match = false;
        }
        
        return match;
    });
    
    renderDoctorsList();
}

function viewDoctorDetails(doctorId) {
    /**
     * –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –≤—Ä–∞—á–∞
     */
    const doctor = allDoctors.find(d => d.id === doctorId);
    
    if (!doctor) {
        alert('‚ùå –í—Ä–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –°–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥
    let details = `
        <strong style="font-size:18px;color:#1976d2;">üë®‚Äç‚öïÔ∏è ${doctor.full_name}</strong><br><br>
        
        <strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> ${doctor.specialization}<br>
        ${doctor.specialty_detail ? `<strong>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> ${doctor.specialty_detail}<br>` : ''}
        ${doctor.position ? `<strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> ${doctor.position}<br>` : ''}
        ${doctor.phone ? `<strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${doctor.phone}<br>` : ''}
        ${doctor.workplace ? `<strong>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã:</strong> ${doctor.workplace}<br>` : ''}
        ${doctor.category ? `<strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${doctor.category}<br>` : ''}
        ${doctor.comments ? `<br><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong><br>${doctor.comments}` : ''}
    `;
    
    if (confirm(`${details}\n\nüìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–∞—á–∞?`)) {
        // –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editDoctor(doctorId);
    }
}

function editDoctor(doctorId) {
    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–∞—á–∞ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
     */
    alert('üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–∞—á–µ–π –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏!');
    // TODO: loadScreen('edit-doctor') —Å –ø–µ—Ä–µ–¥–∞—á–µ–π ID
}

async function exportDoctorsToExcel() {
    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã –≤—Ä–∞—á–µ–π –≤ Excel
     */
    try {
        const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
        
        if (!userId) {
            alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...';
        
        const response = await fetch(`${API_URL}/api/export/doctors?user_id=${userId}`);
        const data = await response.json();
        
        if (data.success) {
            // –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
            const downloadUrl = `${API_URL}/api/download/${data.filename}`;
            window.open(downloadUrl, '_blank');
            
            alert('‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω! –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
        
        btn.disabled = false;
        btn.textContent = 'üìä –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`);
        
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = 'üìä –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel';
    }
}
</script>
