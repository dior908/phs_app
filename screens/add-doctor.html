<!-- –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞ -->
<div class="logo"><div class="logo-icon">üë®‚Äç‚öïÔ∏è</div></div>
<h1>–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</h1>
<p class="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –≤—Ä–∞—á–µ</p>

<form id="addDoctorForm" onsubmit="submitAddDoctor(event)">
    <!-- –§–ò–û –í—Ä–∞—á–∞ -->
    <div class="form-group">
        <label for="doctorFullName">–§–ò–û –í—Ä–∞—á–∞ <span class="required">*</span></label>
        <input type="text" id="doctorFullName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
        <div class="error" id="fullNameError">–í–≤–µ–¥–∏—Ç–µ –§–ò–û –≤—Ä–∞—á–∞</div>
    </div>

    <!-- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è -->
    <div class="form-group">
        <label for="doctorSpecialization">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è <span class="required">*</span></label>
        <select id="doctorSpecialization" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>
            <option value="–û–Ω–∫–æ–ª–æ–≥–∏—è">–û–Ω–∫–æ–ª–æ–≥–∏—è</option>
            <option value="–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è">–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è</option>
            <option value="–ì–∏–Ω–µ–∫–æ–ª–æ–≥–∏—è">–ì–∏–Ω–µ–∫–æ–ª–æ–≥–∏—è</option>
            <option value="–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è">–ö–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è</option>
            <option value="–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è">–ù–µ–≤—Ä–æ–ª–æ–≥–∏—è</option>
            <option value="–ì–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥–∏—è">–ì–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥–∏—è</option>
            <option value="–£—Ä–æ–ª–æ–≥–∏—è">–£—Ä–æ–ª–æ–≥–∏—è</option>
            <option value="–ü—É–ª—å–º–æ–Ω–æ–ª–æ–≥–∏—è">–ü—É–ª—å–º–æ–Ω–æ–ª–æ–≥–∏—è</option>
            <option value="–ù–µ—Ñ—Ä–æ–ª–æ–≥–∏—è">–ù–µ—Ñ—Ä–æ–ª–æ–≥–∏—è</option>
            <option value="–ì–µ–º–∞—Ç–æ–ª–æ–≥–∏—è">–ì–µ–º–∞—Ç–æ–ª–æ–≥–∏—è</option>
            <option value="–†–µ–≤–º–∞—Ç–æ–ª–æ–≥–∏—è">–†–µ–≤–º–∞—Ç–æ–ª–æ–≥–∏—è</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
        <div class="error" id="specializationError">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</div>
    </div>

    <!-- –í–ø–∏—à–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å -->
    <div class="form-group">
        <label for="doctorSpecialtyDetail">–í–ø–∏—à–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</label>
        <input type="text" id="doctorSpecialtyDetail" placeholder="–û–Ω–∫–æ–ª–æ–≥-—É—Ä–æ–ª–æ–≥, –û–Ω–∫–æ–ª–æ–≥-–º–∞–º–º–æ–ª–æ–≥">
        <small style="color:#78909c;font-size:12px;">–ü—Ä–∏–º–µ—Ä: –û–Ω–∫–æ–ª–æ–≥-—É—Ä–æ–ª–æ–≥, –ì–∏–Ω–µ–∫–æ–ª–æ–≥-—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–æ–ª–æ–≥</small>
    </div>

    <!-- –î–æ–ª–∂–Ω–æ—Å—Ç—å -->
    <div class="form-group">
        <label for="doctorPosition">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <input type="text" id="doctorPosition" placeholder="–ó–∞–≤–µ–¥—É—é—â–∏–π –æ—Ç–¥–µ–ª–µ–Ω–∏–µ–º, –ì–ª–∞–≤–Ω—ã–π –≤—Ä–∞—á">
        <small style="color:#78909c;font-size:12px;">–ü—Ä–∏–º–µ—Ä: –ó–∞–≤–µ–¥—É—é—â–∏–π –æ—Ç–¥–µ–ª–µ–Ω–∏–µ–º, –ì–ª–∞–≤–Ω—ã–π –≤—Ä–∞—á, –ë—É—Ö–≥–∞–ª—Ç–µ—Ä</small>
    </div>

    <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
    <div class="form-group">
        <label for="doctorPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
        <input type="tel" id="doctorPhone" placeholder="+998 XX XXX XX XX" pattern="\+998\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}">
        <small style="color:#78909c;font-size:12px;">–§–æ—Ä–º–∞—Ç: +998 XX XXX XX XX</small>
    </div>

    <!-- –ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã -->
    <div class="form-group">
        <label for="doctorWorkplace">–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label>
        <input type="text" id="doctorWorkplace" placeholder="–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –±–æ–ª—å–Ω–∏—Ü–∞ –≥. –¢–∞—à–∫–µ–Ω—Ç">
        <small style="color:#78909c;font-size:12px;">–ü—Ä–∏–º–µ—Ä: –≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –±–æ–ª—å–Ω–∏—Ü–∞ –≥. –¢–∞—à–∫–µ–Ω—Ç</small>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã -->
    <div class="form-group">
        <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã</label>
        <div id="additionalWorkplaces">
            <!-- –ú–µ—Å—Ç–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <button type="button" class="btn" onclick="addWorkplace()" style="margin-top:10px;">
            + –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–Ω–æ –º–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã
        </button>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—Ä–∞—á–∞ -->
    <div class="form-group">
        <label for="doctorCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—Ä–∞—á–∞</label>
        <select id="doctorCategory">
            <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
        <small style="color:#78909c;font-size:12px;">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏</small>
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="form-group">
        <label for="doctorComments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <textarea id="doctorComments" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–∞—á–µ"></textarea>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <button type="submit" class="btn btn-success">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–∞—á–∞</button>
    <button type="button" class="btn btn-secondary" onclick="cancelAddDoctor()">‚ùå –û—Ç–º–µ–Ω–∞</button>
</form>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–û–†–ú–´ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í–†–ê–ß–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let additionalWorkplacesCount = 0;

function init_add_doctor() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞...');
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('doctorPhone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.startsWith('998')) {
                value = value.substring(3);
            }
            
            if (value.length > 0) {
                let formatted = '+998';
                if (value.length > 0) formatted += ' ' + value.substring(0, 2);
                if (value.length > 2) formatted += ' ' + value.substring(2, 5);
                if (value.length > 5) formatted += ' ' + value.substring(5, 7);
                if (value.length > 7) formatted += ' ' + value.substring(7, 9);
                
                e.target.value = formatted.trim();
            }
        });
    }
}

function addWorkplace() {
    /**
     * –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã
     */
    additionalWorkplacesCount++;
    
    const container = document.getElementById('additionalWorkplaces');
    
    const div = document.createElement('div');
    div.className = 'form-group';
    div.style.marginBottom = '10px';
    div.id = `workplace-${additionalWorkplacesCount}`;
    
    div.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
            <input type="text" 
                   id="additionalWorkplace${additionalWorkplacesCount}" 
                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è"
                   style="flex:1;">
            <button type="button" 
                    class="btn" 
                    onclick="removeWorkplace(${additionalWorkplacesCount})"
                    style="padding:12px 16px;min-width:auto;background:linear-gradient(145deg, #ffcdd2, #ef9a9a);">
                ‚úï
            </button>
        </div>
    `;
    
    container.appendChild(div);
}

function removeWorkplace(id) {
    /**
     * –£–¥–∞–ª–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã
     */
    const element = document.getElementById(`workplace-${id}`);
    if (element) {
        element.remove();
    }
}

function cancelAddDoctor() {
    /**
     * –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–æ—Ä–º–µ –≤–∏–∑–∏—Ç–∞
     */
    if (confirm('‚ùì –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—á–∞?')) {
        loadScreen('visit-doctor');
    }
}

async function submitAddDoctor(event) {
    /**
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞
     */
    event.preventDefault();
    
    const userId = window.USER_ID || tg.initDataUnsafe?.user?.id;
    
    if (!userId) {
        alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    // –°–æ–±—Ä–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã
    const additionalWorkplaces = [];
    for (let i = 1; i <= additionalWorkplacesCount; i++) {
        const input = document.getElementById(`additionalWorkplace${i}`);
        if (input && input.value.trim()) {
            additionalWorkplaces.push(input.value.trim());
        }
    }
    
    // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–∞
    const doctorData = {
        user_id: userId,
        full_name: document.getElementById('doctorFullName').value.trim(),
        specialization: document.getElementById('doctorSpecialization').value,
        specialty_detail: document.getElementById('doctorSpecialtyDetail').value.trim(),
        position: document.getElementById('doctorPosition').value.trim(),
        phone: document.getElementById('doctorPhone').value.trim(),
        workplace: document.getElementById('doctorWorkplace').value.trim(),
        additional_workplaces: additionalWorkplaces,
        category: document.getElementById('doctorCategory').value,
        comments: document.getElementById('doctorComments').value.trim()
    };
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞:', doctorData);
    console.log('üì° API URL:', API_URL);
    console.log('üì° Endpoint:', `${API_URL}/api/doctors`);
    
    try {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        console.log('üåê –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞...');
        
        const response = await fetch(`${API_URL}/api/doctors`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(doctorData)
        });
        
        console.log('üì® Response status:', response.status);
        console.log('üì® Response OK:', response.ok);
        
        const result = await response.json();
        
        console.log('üì¶ Response data:', result);
        
        if (result.success) {
            console.log('‚úÖ –í—Ä–∞—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ID:', result.doctor_id);
            alert(`‚úÖ –í—Ä–∞—á "${doctorData.full_name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`);
            
            // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–æ—Ä–º–µ –≤–∏–∑–∏—Ç–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
            loadScreen('visit-doctor');
            
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result.error);
            throw new Error(result.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞:', error);
        console.error('   –¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
        console.error('   –°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
        alert(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—á–∞: ${error.message}`);
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–∞—á–∞';
    }
}
</script>
